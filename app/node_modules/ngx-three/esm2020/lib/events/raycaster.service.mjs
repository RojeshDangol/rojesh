import { Injectable } from '@angular/core';
import * as THREE from 'three';
import * as i0 from "@angular/core";
// eslint-disable-next-line no-shadow
export var RaycasterEvent;
(function (RaycasterEvent) {
    RaycasterEvent["mouseEnter"] = "mouseEnter";
    RaycasterEvent["mouseExit"] = "mouseExit";
    RaycasterEvent["click"] = "click";
})(RaycasterEvent || (RaycasterEvent = {}));
export class RaycasterService {
    constructor() {
        this.raycaster = new THREE.Raycaster();
        this.selected = null;
        this.enabled = true;
        this.groups = [];
        this.paused = false;
        this.maxClickDistance = 23;
        this.nid = RaycasterService.instanceCnt++;
        this.onPointerMove = this.onPointerMove.bind(this);
        this.onPointerDown = this.onPointerDown.bind(this);
        this.onPointerUp = this.onPointerUp.bind(this);
    }
    ngOnDestroy() {
        this.disable();
        this.unsubscribe();
    }
    subscribe() {
        if (!this.canvas) {
            throw new Error('missing canvas');
        }
        this.canvas.addEventListener('pointermove', this.onPointerMove);
        this.canvas.addEventListener('pointerdown', this.onPointerDown);
        this.canvas.addEventListener('pointerup', this.onPointerUp);
    }
    unsubscribe() {
        if (!this.canvas) {
            throw new Error('missing canvas');
        }
        this.canvas.removeEventListener('pointermove', this.onPointerMove);
        this.canvas.removeEventListener('pointerdown', this.onPointerDown);
        this.canvas.removeEventListener('pointerup', this.onPointerUp);
    }
    enable() {
        this.enabled = true;
    }
    disable() {
        this.enabled = false;
    }
    pause() {
        this.paused = true;
    }
    resume() {
        this.paused = false;
    }
    get isEnabled() {
        return this.enabled;
    }
    init(camera, canvas) {
        // console.log('Add camera to raycaster', camera);
        this.camera = camera;
        this.canvas = canvas;
        this.subscribe();
    }
    addEventTarget(target) {
        // console.log('RaycasterService.addGroup', group.name, group);
        this.groups.push(target);
    }
    removeEventTarget(target) {
        const index = this.groups.indexOf(target);
        if (index >= 0) {
            this.groups.splice(index, 1);
        }
    }
    onPointerMove(event /*MouseEvent  & { layerX: number, layerY: number}*/) {
        if (!this.isReady()) {
            return;
        }
        const i = this.getFirstIntersectedGroup(event.layerX, event.layerY);
        if (!this.selected || this.selected !== i.target) {
            if (this.selected) {
                this.selected.host.objRef?.dispatchEvent({
                    type: RaycasterEvent.mouseExit
                });
                this.selected.onMouseExit();
                this.selected = null;
            }
            if (i && i.target) {
                this.selected = i.target;
                const evt = {
                    type: RaycasterEvent.mouseEnter,
                    face: i.face
                };
                this.selected.host.objRef?.dispatchEvent(evt);
                this.selected.onMouseEnter(evt);
            }
        }
    }
    onPointerDown(event) {
        this.maxClickDistance = event.width;
        this.pointerDownEvent = event;
    }
    onPointerUp(event) {
        const downEvent = this.pointerDownEvent;
        this.pointerDownEvent = undefined;
        if (!this.isReady() || this.calcPointerDownUpDinstance(event, downEvent) > this.maxClickDistance) {
            return;
        }
        const i = this.getFirstIntersectedGroup(event.layerX, event.layerY);
        if (i && i.target && i.target.host.objRef) {
            const evt = { type: RaycasterEvent.click, face: i.face };
            i.target.host.objRef.dispatchEvent(evt);
            i.target.onClick(evt);
        }
    }
    isReady(ignorePaused) {
        return !!(this.enabled && (ignorePaused || !this.paused) && this.camera && this.camera.objRef && this.groups && this.groups.length > 0);
    }
    calcPointerDownUpDinstance(upEvent, downEvent) {
        if (!downEvent) {
            return Number.MAX_VALUE;
        }
        const xDist = upEvent.layerX - downEvent.layerX;
        const yDist = upEvent.layerY - downEvent.layerY;
        return Math.sqrt(xDist * xDist + yDist * yDist);
    }
    getFirstIntersectedGroup(x, y) {
        if (!this.camera || !this.canvas || !this.camera.objRef) {
            return { face: null, target: null };
        }
        x = (x / this.canvas.clientWidth) * 2 - 1;
        y = -(y / this.canvas.clientHeight) * 2 + 1;
        const mouseVector = new THREE.Vector2(x, y);
        this.raycaster.setFromCamera(mouseVector, this.camera.objRef);
        let face = null;
        // loop across all groups. Try to find the group with nearest distance.
        let nearestIntersection;
        let nearestGroup;
        for (const group of this.groups) {
            const i = group.host.objRef;
            if (!i) {
                continue;
            }
            const intersection = this.raycaster.intersectObject(i, true);
            if (intersection.length > 0 && (!nearestIntersection || nearestIntersection.distance > intersection[0].distance)) {
                nearestIntersection = intersection[0];
                face = nearestIntersection.face;
                nearestGroup = group;
            }
        }
        // return the group with nearest distance
        if (nearestGroup) {
            return {
                target: nearestGroup,
                face
            };
        }
        else {
            return {
                target: null,
                face: null
            };
        }
    }
}
RaycasterService.instanceCnt = 0;
RaycasterService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: RaycasterService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
RaycasterService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: RaycasterService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: RaycasterService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmF5Y2FzdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdGhyZWUvc3JjL2xpYi9ldmVudHMvcmF5Y2FzdGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUN0RCxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQzs7QUFJL0IscUNBQXFDO0FBQ3JDLE1BQU0sQ0FBTixJQUFZLGNBSVg7QUFKRCxXQUFZLGNBQWM7SUFDeEIsMkNBQXlCLENBQUE7SUFDekIseUNBQXVCLENBQUE7SUFDdkIsaUNBQWUsQ0FBQTtBQUNqQixDQUFDLEVBSlcsY0FBYyxLQUFkLGNBQWMsUUFJekI7QUFRRCxNQUFNLE9BQU8sZ0JBQWdCO0lBb0IzQjtRQWxCUSxjQUFTLEdBQUcsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDbEMsYUFBUSxHQUFtQyxJQUFJLENBQUM7UUFDaEQsWUFBTyxHQUFHLElBQUksQ0FBQztRQUVmLFdBQU0sR0FBbUMsRUFBRSxDQUFDO1FBQzVDLFdBQU0sR0FBRyxLQUFLLENBQUM7UUFFZixxQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFTZCxRQUFHLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFHbkQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVNLFdBQVc7UUFDaEIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFD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QztnQkFDdEMsSUFBSSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQztnQkFDaEMsWUFBWSxHQUFHLEtBQUssQ0FBQzthQUN0QjtTQUNGO1FBRUQseUNBQXlDO1FBQ3pDLElBQUksWUFBWSxFQUFFO1lBQ2hCLE9BQU87Z0JBQ0wsTUFBTSxFQUFFLFlBQVk7Z0JBQ3BCLElBQUk7YUFDTCxDQUFDO1NBQ0g7YUFBTTtZQUNMLE9BQU87Z0JBQ0wsTUFBTSxFQUFFLElBQUk7Z0JBQ1osSUFBSSxFQUFFLElBQUk7YUFDWCxDQUFDO1NBQ0g7SUFDSCxDQUFDOztBQTdLYyw0QkFBVyxHQUFHLENBQUUsQ0FBQTs2R0FYcEIsZ0JBQWdCO2lIQUFoQixnQkFBZ0I7MkZBQWhCLGdCQUFnQjtrQkFENUIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgVGhDYW1lcmEgfSBmcm9tICcuLi9nZW5lcmF0ZWQvVGhDYW1lcmEnO1xuaW1wb3J0IHsgUmF5Y2FzdGVyRXZlbnREaXJlY3RpdmUgfSBmcm9tICcuL3JheWNhc3Rlci5ldmVudHMuZGlyZWN0aXZlJztcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvd1xuZXhwb3J0IGVudW0gUmF5Y2FzdGVyRXZlbnQge1xuICBtb3VzZUVudGVyID0gJ21vdXNlRW50ZXInLFxuICBtb3VzZUV4aXQgPSAnbW91c2VFeGl0JyxcbiAgY2xpY2sgPSAnY2xpY2snXG59XG5cbmludGVyZmFjZSBOZWFyZXN0SW50ZXJzZWN0aW9uIHtcbiAgdGFyZ2V0PzogUmF5Y2FzdGVyRXZlbnREaXJlY3RpdmUgfCBudWxsO1xuICBmYWNlPzogVEhSRUUuRmFjZSB8IG51bGw7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSYXljYXN0ZXJTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBjYW52YXM/OiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgcHJpdmF0ZSByYXljYXN0ZXIgPSBuZXcgVEhSRUUuUmF5Y2FzdGVyKCk7XG4gIHByaXZhdGUgc2VsZWN0ZWQ6IFJheWNhc3RlckV2ZW50RGlyZWN0aXZlIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZW5hYmxlZCA9IHRydWU7XG4gIHByaXZhdGUgY2FtZXJhPzogVGhDYW1lcmE7XG4gIHByaXZhdGUgZ3JvdXBzOiBBcnJheTxSYXljYXN0ZXJFdmVudERpcmVjdGl2ZT4gPSBbXTtcbiAgcHJpdmF0ZSBwYXVzZWQgPSBmYWxzZTtcblxuICBwcml2YXRlIG1heENsaWNrRGlzdGFuY2UgPSAyMztcblxuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZUNudCA9IDA7XG5cbiAgLyoqXG4gICAqIHRhcmdldHMgb2YgdGhlIHBvaW50ZXIgZG93biBldmVudFxuICAgKi9cbiAgcHJpdmF0ZSBwb2ludGVyRG93bkV2ZW50PzogUG9pbnRlckV2ZW50O1xuXG4gIHB1YmxpYyByZWFkb25seSBuaWQgPSBSYXljYXN0ZXJTZXJ2aWNlLmluc3RhbmNlQ250Kys7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5vblBvaW50ZXJNb3ZlID0gdGhpcy5vblBvaW50ZXJNb3ZlLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vblBvaW50ZXJEb3duID0gdGhpcy5vblBvaW50ZXJEb3duLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vblBvaW50ZXJVcCA9IHRoaXMub25Qb2ludGVyVXAuYmluZCh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmRpc2FibGUoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIHN1YnNjcmliZSgpIHtcbiAgICBpZiAoIXRoaXMuY2FudmFzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ21pc3NpbmcgY2FudmFzJyk7XG4gICAgfVxuICAgIHRoaXMuY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJtb3ZlJywgdGhpcy5vblBvaW50ZXJNb3ZlKTtcbiAgICB0aGlzLmNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicsIHRoaXMub25Qb2ludGVyRG93bik7XG4gICAgdGhpcy5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcnVwJywgdGhpcy5vblBvaW50ZXJVcCk7XG4gIH1cblxuICBwcml2YXRlIHVuc3Vic2NyaWJlKCkge1xuICAgIGlmICghdGhpcy5jYW52YXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbWlzc2luZyBjYW52YXMnKTtcbiAgICB9XG4gICAgdGhpcy5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlcm1vdmUnLCB0aGlzLm9uUG9pbnRlck1vdmUpO1xuICAgIHRoaXMuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgdGhpcy5vblBvaW50ZXJEb3duKTtcbiAgICB0aGlzLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdwb2ludGVydXAnLCB0aGlzLm9uUG9pbnRlclVwKTtcbiAgfVxuXG4gIHB1YmxpYyBlbmFibGUoKSB7XG4gICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBkaXNhYmxlKCkge1xuICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHBhdXNlKCkge1xuICAgIHRoaXMucGF1c2VkID0gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyByZXN1bWUoKSB7XG4gICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGdldCBpc0VuYWJsZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZW5hYmxlZDtcbiAgfVxuXG4gIHB1YmxpYyBpbml0KGNhbWVyYTogVGhDYW1lcmEsIGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnQWRkIGNhbWVyYSB0byByYXljYXN0ZXInLCBjYW1lcmEpO1xuICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhO1xuICAgIHRoaXMuY2FudmFzID0gY2FudmFzO1xuICAgIHRoaXMuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwdWJsaWMgYWRkRXZlbnRUYXJnZXQodGFyZ2V0OiBSYXljYXN0ZXJFdmVudERpcmVjdGl2ZSkge1xuICAgIC8vIGNvbnNvbGUubG9nKCdSYXljYXN0ZXJTZXJ2aWNlLmFkZEdyb3VwJywgZ3JvdXAubmFtZSwgZ3JvdXApO1xuICAgIHRoaXMuZ3JvdXBzLnB1c2godGFyZ2V0KTtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVFdmVudFRhcmdldCh0YXJnZXQ6IFJheWNhc3RlckV2ZW50RGlyZWN0aXZlKSB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdyb3Vwcy5pbmRleE9mKHRhcmdldCk7XG4gICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgIHRoaXMuZ3JvdXBzLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblBvaW50ZXJNb3ZlKGV2ZW50OiBhbnkgLypNb3VzZUV2ZW50ICAmIHsgbGF5ZXJYOiBudW1iZXIsIGxheWVyWTogbnVtYmVyfSovKSB7XG4gICAgaWYgKCF0aGlzLmlzUmVhZHkoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpID0gdGhpcy5nZXRGaXJzdEludGVyc2VjdGVkR3JvdXAoZXZlbnQubGF5ZXJYLCBldmVudC5sYXllclkpO1xuICAgIGlmICghdGhpcy5zZWxlY3RlZCB8fCB0aGlzLnNlbGVjdGVkICE9PSBpLnRhcmdldCkge1xuICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZC5ob3N0Lm9ialJlZj8uZGlzcGF0Y2hFdmVudCh7XG4gICAgICAgICAgdHlwZTogUmF5Y2FzdGVyRXZlbnQubW91c2VFeGl0XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNlbGVjdGVkLm9uTW91c2VFeGl0KCk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBudWxsO1xuICAgICAgfVxuICAgICAgaWYgKGkgJiYgaS50YXJnZXQpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IGkudGFyZ2V0O1xuICAgICAgICBjb25zdCBldnQgPSB7XG4gICAgICAgICAgdHlwZTogUmF5Y2FzdGVyRXZlbnQubW91c2VFbnRlcixcbiAgICAgICAgICBmYWNlOiBpLmZhY2VcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZC5ob3N0Lm9ialJlZj8uZGlzcGF0Y2hFdmVudChldnQpO1xuICAgICAgICB0aGlzLnNlbGVjdGVkLm9uTW91c2VFbnRlcihldnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25Qb2ludGVyRG93bihldmVudDogUG9pbnRlckV2ZW50KSB7XG4gICAgdGhpcy5tYXhDbGlja0Rpc3RhbmNlID0gZXZlbnQud2lkdGg7XG4gICAgdGhpcy5wb2ludGVyRG93bkV2ZW50ID0gZXZlbnQ7XG4gIH1cblxuICBwcml2YXRlIG9uUG9pbnRlclVwKGV2ZW50OiBQb2ludGVyRXZlbnQpIHtcbiAgICBjb25zdCBkb3duRXZlbnQgPSB0aGlzLnBvaW50ZXJEb3duRXZlbnQ7XG4gICAgdGhpcy5wb2ludGVyRG93bkV2ZW50ID0gdW5kZWZpbmVkO1xuXG4gICAgaWYgKCF0aGlzLmlzUmVhZHkoKSB8fCB0aGlzLmNhbGNQb2ludGVyRG93blVwRGluc3RhbmNlKGV2ZW50LCBkb3duRXZlbnQpID4gdGhpcy5tYXhDbGlja0Rpc3RhbmNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGkgPSB0aGlzLmdldEZpcnN0SW50ZXJzZWN0ZWRHcm91cCgoZXZlbnQgYXMgYW55KS5sYXllclgsIChldmVudCBhcyBhbnkpLmxheWVyWSk7XG4gICAgaWYgKGkgJiYgaS50YXJnZXQgJiYgaS50YXJnZXQuaG9zdC5vYmpSZWYpIHtcbiAgICAgIGNvbnN0IGV2dCA9IHsgdHlwZTogUmF5Y2FzdGVyRXZlbnQuY2xpY2ssIGZhY2U6IGkuZmFjZSB9O1xuICAgICAgaS50YXJnZXQuaG9zdC5vYmpSZWYuZGlzcGF0Y2hFdmVudChldnQpO1xuICAgICAgaS50YXJnZXQub25DbGljayhldnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNSZWFkeShpZ25vcmVQYXVzZWQ/OiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhKHRoaXMuZW5hYmxlZCAmJiAoaWdub3JlUGF1c2VkIHx8ICF0aGlzLnBhdXNlZCkgJiYgdGhpcy5jYW1lcmEgJiYgdGhpcy5jYW1lcmEub2JqUmVmICYmIHRoaXMuZ3JvdXBzICYmIHRoaXMuZ3JvdXBzLmxlbmd0aCA+IDApO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjUG9pbnRlckRvd25VcERpbnN0YW5jZSh1cEV2ZW50OiBQb2ludGVyRXZlbnQsIGRvd25FdmVudD86IFBvaW50ZXJFdmVudCkge1xuICAgIGlmICghZG93bkV2ZW50KSB7XG4gICAgICByZXR1cm4gTnVtYmVyLk1BWF9WQUxVRTtcbiAgICB9XG4gICAgY29uc3QgeERpc3QgPSAodXBFdmVudCBhcyBhbnkpLmxheWVyWCAtIChkb3duRXZlbnQgYXMgYW55KS5sYXllclg7XG4gICAgY29uc3QgeURpc3QgPSAodXBFdmVudCBhcyBhbnkpLmxheWVyWSAtIChkb3duRXZlbnQgYXMgYW55KS5sYXllclk7XG4gICAgcmV0dXJuIE1hdGguc3FydCh4RGlzdCAqIHhEaXN0ICsgeURpc3QgKiB5RGlzdCk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0SW50ZXJzZWN0ZWRHcm91cCh4OiBudW1iZXIsIHk6IG51bWJlcik6IE5lYXJlc3RJbnRlcnNlY3Rpb24ge1xuICAgIGlmICghdGhpcy5jYW1lcmEgfHwgIXRoaXMuY2FudmFzIHx8ICF0aGlzLmNhbWVyYS5vYmpSZWYpIHtcbiAgICAgIHJldHVybiB7IGZhY2U6IG51bGwsIHRhcmdldDogbnVsbCB9O1xuICAgIH1cbiAgICB4ID0gKHggLyB0aGlzLmNhbnZhcy5jbGllbnRXaWR0aCkgKiAyIC0gMTtcbiAgICB5ID0gLSh5IC8gdGhpcy5jYW52YXMuY2xpZW50SGVpZ2h0KSAqIDIgKyAxO1xuICAgIGNvbnN0IG1vdXNlVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjIoeCwgeSk7XG4gICAgdGhpcy5yYXljYXN0ZXIuc2V0RnJvbUNhbWVyYShtb3VzZVZlY3RvciwgdGhpcy5jYW1lcmEub2JqUmVmKTtcbiAgICBsZXQgZmFjZSA9IG51bGw7XG5cbiAgICAvLyBsb29wIGFjcm9zcyBhbGwgZ3JvdXBzLiBUcnkgdG8gZmluZCB0aGUgZ3JvdXAgd2l0aCBuZWFyZXN0IGRpc3RhbmNlLlxuICAgIGxldCBuZWFyZXN0SW50ZXJzZWN0aW9uOiBUSFJFRS5JbnRlcnNlY3Rpb24gfCB1bmRlZmluZWQ7XG4gICAgbGV0IG5lYXJlc3RHcm91cDogUmF5Y2FzdGVyRXZlbnREaXJlY3RpdmUgfCB1bmRlZmluZWQ7XG4gICAgZm9yIChjb25zdCBncm91cCBvZiB0aGlzLmdyb3Vwcykge1xuICAgICAgY29uc3QgaSA9IGdyb3VwLmhvc3Qub2JqUmVmO1xuICAgICAgaWYgKCFpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gdGhpcy5yYXljYXN0ZXIuaW50ZXJzZWN0T2JqZWN0KGksIHRydWUpO1xuICAgICAgaWYgKGludGVyc2VjdGlvbi5sZW5ndGggPiAwICYmICghbmVhcmVzdEludGVyc2VjdGlvbiB8fCBuZWFyZXN0SW50ZXJzZWN0aW9uLmRpc3RhbmNlID4gaW50ZXJzZWN0aW9uWzBdLmRpc3RhbmNlKSkge1xuICAgICAgICBuZWFyZXN0SW50ZXJzZWN0aW9uID0gaW50ZXJzZWN0aW9uWzBdO1xuICAgICAgICBmYWNlID0gbmVhcmVzdEludGVyc2VjdGlvbi5mYWNlO1xuICAgICAgICBuZWFyZXN0R3JvdXAgPSBncm91cDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyByZXR1cm4gdGhlIGdyb3VwIHdpdGggbmVhcmVzdCBkaXN0YW5jZVxuICAgIGlmIChuZWFyZXN0R3JvdXApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRhcmdldDogbmVhcmVzdEdyb3VwLFxuICAgICAgICBmYWNlXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB0YXJnZXQ6IG51bGwsXG4gICAgICAgIGZhY2U6IG51bGxcbiAgICAgIH07XG4gICAgfVxuICB9XG59XG4iXX0=