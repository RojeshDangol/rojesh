import { EventEmitter, Injectable } from '@angular/core';
import * as THREE from 'three';
import { Vector4 } from 'three';
import * as i0 from "@angular/core";
export class ThEngineService {
    constructor(ngZone) {
        this.ngZone = ngZone;
        this.views = [];
        this.beforeRenderEmitter = new EventEmitter();
        this.beforeRender$ = this.beforeRenderEmitter.asObservable();
    }
    get renderer() {
        return this._renderer;
    }
    ngOnDestroy() {
        if (this.frameId !== undefined) {
            cancelAnimationFrame(this.frameId);
        }
        if (this.resizeObserver && this.canvas) {
            this.resizeObserver.unobserve(this.canvas);
        }
    }
    initResizeObserver() {
        // We have to run this outside angular zones,
        // because it could trigger heavy changeDetection cycles.
        this.ngZone.runOutsideAngular(() => {
            if (!this.canvas) {
                throw new Error('missing canvas element');
            }
            if (!this.resizeObserver) {
                // @ts-ignore
                this.resizeObserver = new ResizeObserver(() => {
                    this.resize();
                });
            }
            this.resizeObserver.observe(this.canvas);
        });
    }
    initRenderer() {
        if (this._renderer) {
            return;
        }
        this._renderer = new THREE.WebGLRenderer({
            canvas: this.canvas,
            alpha: true,
            antialias: true,
            preserveDrawingBuffer: true
        });
        this.resize();
        // this.renderer.setSize(this.canvas?.width ?? 0, this.canvas?.width ?? 0);
    }
    setCanvas(canvas) {
        this.canvas = canvas;
        this.initRenderer();
        this.initResizeObserver();
    }
    addView(view) {
        this.views.push(view);
    }
    requestAnimationFrame() {
        if (this.frameId === undefined) {
            this.ngZone.runOutsideAngular(() => (this.frameId = requestAnimationFrame(() => {
                this.render();
            })));
        }
    }
    /*
    public animate(): void {
      // We have to run this outside angular zones,
      // because it could trigger heavy changeDetection cycles.
      this.ngZone.runOutsideAngular(() => {
        if (document.readyState !== 'loading') {
          this.render();
        } else {
          window.addEventListener('DOMContentLoaded', () => {
            this.render();
          });
        }
      });
    }
    */
    render() {
        this.frameId = undefined;
        // TODO: conditional rendere loop
        this.requestAnimationFrame();
        // emit before render
        this.beforeRenderEmitter.next({ engine: this });
        for (const view of this.views) {
            this.renderView(view);
        }
    }
    renderView(view) {
        if (!this._renderer) {
            return;
        }
        const camera = view.camera;
        const scene = view.scene;
        if (!camera || !scene || !camera.objRef || !scene.objRef) {
            return;
        }
        const renderer = this._renderer;
        if (view.onRender.observers.length) {
            this.ngZone.run(() => view.onRender.emit({
                renderer,
                scene,
                camera
            }));
        }
        this.applyRendererParametersFromView(view);
        if (view.effectComposer) {
            view.effectComposer.render();
        }
        else {
            this._renderer.render(scene.objRef, camera.objRef);
        }
    }
    applyRendererParametersFromView(view) {
        if (!this._renderer) {
            return;
        }
        if (view.viewPort) {
            if (view.viewPort instanceof Vector4) {
                this._renderer.setViewport(view.viewPort);
            }
            else {
                this._renderer.setViewport(view.viewPort.x, view.viewPort.y, view.viewPort.width, view.viewPort.height);
            }
        }
        if (view.scissor) {
            if (view.scissor instanceof Vector4) {
                this._renderer.setScissor(view.scissor);
            }
            else {
                this._renderer.setScissor(view.scissor.x, view.scissor.y, view.scissor.width, view.scissor.height);
            }
        }
        if (view.scissorTest !== undefined) {
            this._renderer.setScissorTest(view.scissorTest);
        }
        if (view.clearColor) {
            this._renderer.setClearColor(view.clearColor);
        }
        if (view.clearAlpha !== undefined) {
            this._renderer.setClearAlpha(view.clearAlpha);
        }
        if (view.shadow !== undefined) {
            this._renderer.shadowMap.enabled = true;
        }
    }
    resize() {
        if (!this._renderer) {
            return;
        }
        const width = this.canvas?.parentElement?.clientWidth ?? 0;
        const height = this.canvas?.parentElement?.clientHeight ?? 0;
        this._renderer.setSize(width, height, false);
        for (const view of this.views) {
            if (!view.viewPort) {
                if (view.camera && view.camera.objRef.aspect) {
                    view.camera.objRef.aspect = width / height;
                    view.camera.objRef.updateProjectionMatrix();
                }
                view.effectComposer?.setSize(width, height);
            }
        }
    }
}
ThEngineService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: ThEngineService, deps: [{ token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Injectable });
ThEngineService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: ThEngineService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: ThEngineService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i0.NgZone }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGhFbmdpbmUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC10aHJlZS9zcmMvbGliL1RoRW5naW5lLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQzVFLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxPQUFPLENBQUM7O0FBSWhDLE1BQU0sT0FBTyxlQUFlO0lBWTFCLFlBQTJCLE1BQWM7UUFBZCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBVmpDLFVBQUssR0FBYSxFQUFFLENBQUM7UUFHWix3QkFBbUIsR0FBRyxJQUFJLFlBQVksRUFBNkIsQ0FBQztRQUNyRSxrQkFBYSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQU01QixDQUFDO0lBRTdDLElBQVcsUUFBUTtRQUNqQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQUVNLFdBQVc7UUFDaEIsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLFNBQVMsRUFBRTtZQUM5QixvQkFBb0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDcEM7UUFFRCxJQUFJLElBQUksQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN0QyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDNUM7SUFDSCxDQUFDO0lBRU8sa0JBQWtCO1FBQ3hCLDZDQUE2QztRQUM3Qyx5REFBeUQ7UUFDekQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7WUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQzthQUMzQztZQUVELElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN4QixhQUFhO2dCQUNiLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFO29CQUM1QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ2hCLENBQUMsQ0FBQyxDQUFDO2FBQ0o7WUFDRCxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sWUFBWTtRQUNsQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUM7WUFDdkMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ25CLEtBQUssRUFBRSxJQUFJO1lBQ1gsU0FBUyxFQUFFLElBQUk7WUFDZixxQkFBcUIsRUFBRSxJQUFJO1NBQzVCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUVkLDJFQUEyRTtJQUM3RSxDQUFDO0lBRU0sU0FBUyxDQUFDLE1BQXlCO1FBQ3hDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRU0sT0FBTyxDQUFDLElBQVk7UUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVNLHFCQUFxQjtRQUMxQixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssU0FBUyxFQUFFO1lBQzlCLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQzNCLEdBQUcsRUFBRSxDQUNILENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxxQkFBcUIsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3pDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQyxDQUNOLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7Ozs7Ozs7Ozs7Ozs7TUFjRTtJQUVRLE1BQU07UUFDZCxJQUFJLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQztRQUV6QixpQ0FBaUM7UUFDakMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFN0IscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUU5QyxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDN0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN2QjtJQUNILENBQUM7SUFFUyxVQUFVLENBQUMsSUFBWTtRQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFFRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFekIsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3hELE9BQU87U0FDUjtRQUVELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7UUFFaEMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDbEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQ25CLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO2dCQUNqQixRQUFRO2dCQUNSLEtBQUs7Z0JBQ0wsTUFBTTthQUNQLENBQUMsQ0FDSCxDQUFDO1NBQ0g7UUFFRCxJQUFJLENBQUMsK0JBQStCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0MsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDOUI7YUFBTTtZQUNMLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3BEO0lBQ0gsQ0FBQztJQUVTLCtCQUErQixDQUFDLElBQVk7UUFDcEQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbkIsT0FBTztTQUNSO1FBQ0QsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2pCLElBQUksSUFBSSxDQUFDLFFBQVEsWUFBWSxPQUFPLEVBQUU7Z0JBQ3BDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUMzQztpQkFBTTtnQkFDTCxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3pHO1NBQ0Y7UUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxJQUFJLENBQUMsT0FBTyxZQUFZLE9BQU8sRUFBRTtnQkFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3pDO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDcEc7U0FDRjtRQUVELElBQUksSUFBSSxDQUFDLFdBQVcsS0FBSyxTQUFTLEVBQUU7WUFDbEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ2pEO1FBRUQsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMvQztRQUVELElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxTQUFTLEVBQUU7WUFDakMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQy9DO1FBRUQsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVMsRUFBRTtZQUM3QixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1NBQ3pDO0lBQ0gsQ0FBQztJQUVNLE1BQU07UUFDWCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLGFBQWEsRUFBRSxXQUFXLElBQUksQ0FBQyxDQUFDO1FBQzNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsYUFBYSxFQUFFLFlBQVksSUFBSSxDQUFDLENBQUM7UUFFN0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU3QyxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2xCLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQWMsQ0FBQyxNQUFNLEVBQUU7b0JBQ3BELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBYyxDQUFDLE1BQU0sR0FBRyxLQUFLLEdBQUcsTUFBTSxDQUFDO29CQUNuRCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQWMsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO2lCQUN0RDtnQkFFRCxJQUFJLENBQUMsY0FBYyxFQUFFLE9BQU8sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDN0M7U0FDRjtJQUNILENBQUM7OzRHQXpNVSxlQUFlO2dIQUFmLGVBQWU7MkZBQWYsZUFBZTtrQkFEM0IsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciwgSW5qZWN0YWJsZSwgTmdab25lLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCAqIGFzIFRIUkVFIGZyb20gJ3RocmVlJztcbmltcG9ydCB7IFZlY3RvcjQgfSBmcm9tICd0aHJlZSc7XG5pbXBvcnQgeyBUaFZpZXcgfSBmcm9tICcuL1RoVmlldyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUaEVuZ2luZVNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIF9yZW5kZXJlcj86IFRIUkVFLldlYkdMUmVuZGVyZXI7XG4gIHByaXZhdGUgdmlld3M6IFRoVmlld1tdID0gW107XG4gIHByaXZhdGUgZnJhbWVJZD86IG51bWJlcjtcblxuICBwcml2YXRlIHJlYWRvbmx5IGJlZm9yZVJlbmRlckVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPHtlbmdpbmU6IFRoRW5naW5lU2VydmljZX0+KCk7XG4gIHB1YmxpYyByZWFkb25seSBiZWZvcmVSZW5kZXIkID0gdGhpcy5iZWZvcmVSZW5kZXJFbWl0dGVyLmFzT2JzZXJ2YWJsZSgpO1xuICBwdWJsaWMgY2FudmFzPzogSFRNTENhbnZhc0VsZW1lbnQ7XG5cbiAgLy8gQHRzLWlnbm9yZVxuICBwcml2YXRlIHJlc2l6ZU9ic2VydmVyPzogUmVzaXplT2JzZXJ2ZXI7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHt9XG5cbiAgcHVibGljIGdldCByZW5kZXJlcigpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVuZGVyZXI7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZnJhbWVJZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLmZyYW1lSWQpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc2l6ZU9ic2VydmVyICYmIHRoaXMuY2FudmFzKSB7XG4gICAgICB0aGlzLnJlc2l6ZU9ic2VydmVyLnVub2JzZXJ2ZSh0aGlzLmNhbnZhcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0UmVzaXplT2JzZXJ2ZXIoKSB7XG4gICAgLy8gV2UgaGF2ZSB0byBydW4gdGhpcyBvdXRzaWRlIGFuZ3VsYXIgem9uZXMsXG4gICAgLy8gYmVjYXVzZSBpdCBjb3VsZCB0cmlnZ2VyIGhlYXZ5IGNoYW5nZURldGVjdGlvbiBjeWNsZXMuXG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmNhbnZhcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ21pc3NpbmcgY2FudmFzIGVsZW1lbnQnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLnJlc2l6ZU9ic2VydmVyKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZXNpemUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0aGlzLnJlc2l6ZU9ic2VydmVyLm9ic2VydmUodGhpcy5jYW52YXMpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0UmVuZGVyZXIoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3JlbmRlcmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3JlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoe1xuICAgICAgY2FudmFzOiB0aGlzLmNhbnZhcyxcbiAgICAgIGFscGhhOiB0cnVlLCAvLyB0cmFuc3BhcmVudCBiYWNrZ3JvdW5kXG4gICAgICBhbnRpYWxpYXM6IHRydWUsIC8vIHNtb290aCBlZGdlc1xuICAgICAgcHJlc2VydmVEcmF3aW5nQnVmZmVyOiB0cnVlXG4gICAgfSk7XG5cbiAgICB0aGlzLnJlc2l6ZSgpO1xuXG4gICAgLy8gdGhpcy5yZW5kZXJlci5zZXRTaXplKHRoaXMuY2FudmFzPy53aWR0aCA/PyAwLCB0aGlzLmNhbnZhcz8ud2lkdGggPz8gMCk7XG4gIH1cblxuICBwdWJsaWMgc2V0Q2FudmFzKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpIHtcbiAgICB0aGlzLmNhbnZhcyA9IGNhbnZhcztcbiAgICB0aGlzLmluaXRSZW5kZXJlcigpO1xuICAgIHRoaXMuaW5pdFJlc2l6ZU9ic2VydmVyKCk7XG4gIH1cblxuICBwdWJsaWMgYWRkVmlldyh2aWV3OiBUaFZpZXcpIHtcbiAgICB0aGlzLnZpZXdzLnB1c2godmlldyk7XG4gIH1cblxuICBwdWJsaWMgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCkge1xuICAgIGlmICh0aGlzLmZyYW1lSWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoXG4gICAgICAgICgpID0+XG4gICAgICAgICAgKHRoaXMuZnJhbWVJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcigpO1xuICAgICAgICAgIH0pKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKlxuICBwdWJsaWMgYW5pbWF0ZSgpOiB2b2lkIHtcbiAgICAvLyBXZSBoYXZlIHRvIHJ1biB0aGlzIG91dHNpZGUgYW5ndWxhciB6b25lcyxcbiAgICAvLyBiZWNhdXNlIGl0IGNvdWxkIHRyaWdnZXIgaGVhdnkgY2hhbmdlRGV0ZWN0aW9uIGN5Y2xlcy5cbiAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAhPT0gJ2xvYWRpbmcnKSB7XG4gICAgICAgIHRoaXMucmVuZGVyKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICB0aGlzLnJlbmRlcigpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICAqL1xuXG4gIHByb3RlY3RlZCByZW5kZXIoKTogdm9pZCB7XG4gICAgdGhpcy5mcmFtZUlkID0gdW5kZWZpbmVkO1xuXG4gICAgLy8gVE9ETzogY29uZGl0aW9uYWwgcmVuZGVyZSBsb29wXG4gICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKTtcblxuICAgIC8vIGVtaXQgYmVmb3JlIHJlbmRlclxuICAgIHRoaXMuYmVmb3JlUmVuZGVyRW1pdHRlci5uZXh0KHtlbmdpbmU6IHRoaXN9KTtcblxuICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLnZpZXdzKSB7XG4gICAgICB0aGlzLnJlbmRlclZpZXcodmlldyk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHJlbmRlclZpZXcodmlldzogVGhWaWV3KSB7XG4gICAgaWYgKCF0aGlzLl9yZW5kZXJlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNhbWVyYSA9IHZpZXcuY2FtZXJhO1xuICAgIGNvbnN0IHNjZW5lID0gdmlldy5zY2VuZTtcblxuICAgIGlmICghY2FtZXJhIHx8ICFzY2VuZSB8fCAhY2FtZXJhLm9ialJlZiB8fCAhc2NlbmUub2JqUmVmKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLl9yZW5kZXJlcjtcblxuICAgIGlmICh2aWV3Lm9uUmVuZGVyLm9ic2VydmVycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PlxuICAgICAgICB2aWV3Lm9uUmVuZGVyLmVtaXQoe1xuICAgICAgICAgIHJlbmRlcmVyLFxuICAgICAgICAgIHNjZW5lLFxuICAgICAgICAgIGNhbWVyYVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmFwcGx5UmVuZGVyZXJQYXJhbWV0ZXJzRnJvbVZpZXcodmlldyk7XG4gICAgaWYgKHZpZXcuZWZmZWN0Q29tcG9zZXIpIHtcbiAgICAgIHZpZXcuZWZmZWN0Q29tcG9zZXIucmVuZGVyKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbmRlcihzY2VuZS5vYmpSZWYsIGNhbWVyYS5vYmpSZWYpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBhcHBseVJlbmRlcmVyUGFyYW1ldGVyc0Zyb21WaWV3KHZpZXc6IFRoVmlldykge1xuICAgIGlmICghdGhpcy5fcmVuZGVyZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHZpZXcudmlld1BvcnQpIHtcbiAgICAgIGlmICh2aWV3LnZpZXdQb3J0IGluc3RhbmNlb2YgVmVjdG9yNCkge1xuICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRWaWV3cG9ydCh2aWV3LnZpZXdQb3J0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFZpZXdwb3J0KHZpZXcudmlld1BvcnQueCwgdmlldy52aWV3UG9ydC55LCB2aWV3LnZpZXdQb3J0LndpZHRoLCB2aWV3LnZpZXdQb3J0LmhlaWdodCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHZpZXcuc2Npc3Nvcikge1xuICAgICAgaWYgKHZpZXcuc2Npc3NvciBpbnN0YW5jZW9mIFZlY3RvcjQpIHtcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U2Npc3Nvcih2aWV3LnNjaXNzb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U2Npc3Nvcih2aWV3LnNjaXNzb3IueCwgdmlldy5zY2lzc29yLnksIHZpZXcuc2Npc3Nvci53aWR0aCwgdmlldy5zY2lzc29yLmhlaWdodCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHZpZXcuc2Npc3NvclRlc3QgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U2Npc3NvclRlc3Qodmlldy5zY2lzc29yVGVzdCk7XG4gICAgfVxuXG4gICAgaWYgKHZpZXcuY2xlYXJDb2xvcikge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0Q2xlYXJDb2xvcih2aWV3LmNsZWFyQ29sb3IpO1xuICAgIH1cblxuICAgIGlmICh2aWV3LmNsZWFyQWxwaGEgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0Q2xlYXJBbHBoYSh2aWV3LmNsZWFyQWxwaGEpO1xuICAgIH1cblxuICAgIGlmICh2aWV3LnNoYWRvdyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLl9yZW5kZXJlci5zaGFkb3dNYXAuZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlc2l6ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuX3JlbmRlcmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHdpZHRoID0gdGhpcy5jYW52YXM/LnBhcmVudEVsZW1lbnQ/LmNsaWVudFdpZHRoID8/IDA7XG4gICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jYW52YXM/LnBhcmVudEVsZW1lbnQ/LmNsaWVudEhlaWdodCA/PyAwO1xuXG4gICAgdGhpcy5fcmVuZGVyZXIuc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0LCBmYWxzZSk7XG5cbiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy52aWV3cykge1xuICAgICAgaWYgKCF2aWV3LnZpZXdQb3J0KSB7XG4gICAgICAgIGlmICh2aWV3LmNhbWVyYSAmJiAodmlldy5jYW1lcmEub2JqUmVmIGFzIGFueSkuYXNwZWN0KSB7XG4gICAgICAgICAgKHZpZXcuY2FtZXJhLm9ialJlZiBhcyBhbnkpLmFzcGVjdCA9IHdpZHRoIC8gaGVpZ2h0O1xuICAgICAgICAgICh2aWV3LmNhbWVyYS5vYmpSZWYgYXMgYW55KS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgICAgIH1cblxuICAgICAgICB2aWV3LmVmZmVjdENvbXBvc2VyPy5zZXRTaXplKHdpZHRoLCBoZWlnaHQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19