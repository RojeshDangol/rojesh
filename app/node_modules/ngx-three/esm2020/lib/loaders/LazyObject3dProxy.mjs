import { Object3D } from 'three';
import { applyValue, isSettable } from '../util';
class Object3DProxyHandler {
    constructor() {
        this.memberMap = new Map();
        this.children = [];
        this.eventListener = {};
        this.add = (...object) => {
            if (this.objRef) {
                this.objRef.add(...object);
            }
            this.children.push(...object);
            return this;
        };
        this.remove = (...object) => {
            if (this.objRef) {
                this.objRef.remove(...object);
            }
            for (const obj of object) {
                const index = this.children.indexOf(obj);
                if (index >= 0) {
                    this.children = this.children.splice(index, 1);
                }
            }
            return this;
        };
        this.applyToObject3D = (objRef) => {
            this.memberMap.forEach((value, key) => {
                const member = objRef[key];
                if (isSettable(member)) {
                    applyValue(member, value);
                }
                else {
                    objRef[key] = value;
                }
            });
            this.children.forEach((child) => objRef.add(child));
            if (this.objRef?.parent) {
                const parent = this.objRef?.parent;
                parent.remove(this.objRef);
                parent.add(objRef);
            }
        };
        /**
         * Adds a listener to an event type.
         *
         * @param type The type of event to listen to.
         * @param listener The function that gets called when the event is fired.
         */
        this.addEventListener = (type, listener) => {
            let arr = this.eventListener[type];
            if (!arr) {
                arr = [];
                this.eventListener[type] = arr;
            }
            arr.push(listener);
            if (this.objRef) {
                this.objRef.addEventListener(type, listener);
            }
        };
        /**
         * Removes a listener from an event type.
         *
         * @param type The type of the listener that gets removed.
         * @param listener The listener function that gets removed.
         */
        this.removeEventListener = (type, listener) => {
            const arr = this.eventListener[type];
            if (!arr) {
                return;
            }
            const index = arr.indexOf(listener);
            if (index >= 0) {
                arr.splice(index, 1);
            }
        };
    }
    get(target, p, receiver) {
        switch (p) {
            case '__isProxy':
                return true;
            case 'applyToObject3D':
                return this.applyToObject3D;
            case 'objRef':
                return this.objRef;
            case 'add':
                return this.add;
            case 'remove':
                return this.remove;
            case 'children':
                return this.objRef ? this.objRef.children : this.children;
            default: {
                const objKey = p;
                let value = this.objRef ? this.objRef[objKey] : this.memberMap.get(objKey);
                if (value === undefined) {
                    value = target[objKey];
                    if (value !== undefined) {
                        // this is necessary for complex members
                        // (returned by reference, they might be altered, we have to reapply them to the real object )
                        this.memberMap.set(objKey, value);
                    }
                }
                return value ?? target[objKey];
            }
        }
    }
    set(target, p, value, receiver) {
        if (p === 'objRef') {
            if (value) {
                this.applyToObject3D(value);
            }
            this.objRef = value;
        }
        else {
            // store to the member map
            this.memberMap.set(p, value);
            if (this.objRef) {
                // and apply to the real object if present
                this.objRef[p] = value;
            }
        }
        return true;
    }
}
export function createLazyObject3DProxy() {
    return new Proxy(new Object3D(), new Object3DProxyHandler());
}
export function isLazyObject3dProxy(object) {
    // eslint-disable-next-line no-underscore-dangle
    return object.__isProxy === true && object.objRef === undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGF6eU9iamVjdDNkUHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdGhyZWUvc3JjL2xpYi9sb2FkZXJzL0xhenlPYmplY3QzZFByb3h5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQVMsTUFBTSxPQUFPLENBQUM7QUFDeEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFakQsTUFBTSxvQkFBb0I7SUFBMUI7UUFFWSxjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQXVCLENBQUM7UUFDM0MsYUFBUSxHQUFlLEVBQUUsQ0FBQztRQUMxQixrQkFBYSxHQUFrRCxFQUFFLENBQUM7UUFpRDVFLFFBQUcsR0FBRyxDQUFDLEdBQUcsTUFBa0IsRUFBUSxFQUFFO1lBQ3BDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO2FBQzVCO1lBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztZQUU5QixPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQztRQUVGLFdBQU0sR0FBRyxDQUFDLEdBQUcsTUFBa0IsRUFBUSxFQUFFO1lBQ3ZDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDZixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO2FBQy9CO1lBRUQsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUU7Z0JBQ3hCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUN6QyxJQUFJLEtBQUssSUFBSSxDQUFDLEVBQUU7b0JBQ2QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENB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QUNkLENBQUM7Q0FtRkY7QUFTRCxNQUFNLFVBQVUsdUJBQXVCO0lBQ3JDLE9BQU8sSUFBSSxLQUFLLENBQW9CLElBQUksUUFBUSxFQUF1QixFQUFFLElBQUksb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZHLENBQUM7QUFFRCxNQUFNLFVBQVUsbUJBQW1CLENBQUMsTUFBb0M7SUFDdEUsZ0RBQWdEO0lBQ2hELE9BQVEsTUFBNEIsQ0FBQyxTQUFTLEtBQUssSUFBSSxJQUFLLE1BQTRCLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQztBQUNoSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JqZWN0M0QsIEV2ZW50IH0gZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgYXBwbHlWYWx1ZSwgaXNTZXR0YWJsZSB9IGZyb20gJy4uL3V0aWwnO1xuXG5jbGFzcyBPYmplY3QzRFByb3h5SGFuZGxlciBpbXBsZW1lbnRzIFByb3h5SGFuZGxlcjxPYmplY3QzRD4ge1xuICBwcm90ZWN0ZWQgb2JqUmVmPzogT2JqZWN0M0Q7XG4gIHByb3RlY3RlZCBtZW1iZXJNYXAgPSBuZXcgTWFwPGtleW9mIE9iamVjdDNELCBhbnk+KCk7XG4gIHByb3RlY3RlZCBjaGlsZHJlbjogT2JqZWN0M0RbXSA9IFtdO1xuICBwcm90ZWN0ZWQgZXZlbnRMaXN0ZW5lcjogeyBba2V5OiBzdHJpbmddOiAoKGV2ZW50OiBFdmVudCkgPT4gdm9pZClbXSB9ID0ge307XG5cbiAgZ2V0KHRhcmdldDogT2JqZWN0M0QsIHA6IGtleW9mIExhenlPYmplY3QzRFByb3h5LCByZWNlaXZlcjogYW55KTogYW55IHtcbiAgICBzd2l0Y2ggKHApIHtcbiAgICAgIGNhc2UgJ19faXNQcm94eSc6XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgY2FzZSAnYXBwbHlUb09iamVjdDNEJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlUb09iamVjdDNEO1xuICAgICAgY2FzZSAnb2JqUmVmJzpcbiAgICAgICAgcmV0dXJuIHRoaXMub2JqUmVmO1xuICAgICAgY2FzZSAnYWRkJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkO1xuICAgICAgY2FzZSAncmVtb3ZlJzpcbiAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlO1xuICAgICAgY2FzZSAnY2hpbGRyZW4nOlxuICAgICAgICByZXR1cm4gdGhpcy5vYmpSZWYgPyB0aGlzLm9ialJlZi5jaGlsZHJlbiA6IHRoaXMuY2hpbGRyZW47XG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIGNvbnN0IG9iaktleSA9IHAgYXMga2V5b2YgT2JqZWN0M0Q7XG4gICAgICAgIGxldCB2YWx1ZSA9IHRoaXMub2JqUmVmID8gdGhpcy5vYmpSZWZbb2JqS2V5XSA6IHRoaXMubWVtYmVyTWFwLmdldChvYmpLZXkpO1xuICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHZhbHVlID0gdGFyZ2V0W29iaktleV07XG4gICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgaXMgbmVjZXNzYXJ5IGZvciBjb21wbGV4IG1lbWJlcnNcbiAgICAgICAgICAgIC8vIChyZXR1cm5lZCBieSByZWZlcmVuY2UsIHRoZXkgbWlnaHQgYmUgYWx0ZXJlZCwgd2UgaGF2ZSB0byByZWFwcGx5IHRoZW0gdG8gdGhlIHJlYWwgb2JqZWN0IClcbiAgICAgICAgICAgIHRoaXMubWVtYmVyTWFwLnNldChvYmpLZXksIHZhbHVlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlID8/IHRhcmdldFtvYmpLZXldO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldCh0YXJnZXQ6IE9iamVjdDNELCBwOiBrZXlvZiBMYXp5T2JqZWN0M0RQcm94eSwgdmFsdWU6IGFueSwgcmVjZWl2ZXI6IGFueSk6IGJvb2xlYW4ge1xuICAgIGlmIChwID09PSAnb2JqUmVmJykge1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIHRoaXMuYXBwbHlUb09iamVjdDNEKHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIHRoaXMub2JqUmVmID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHN0b3JlIHRvIHRoZSBtZW1iZXIgbWFwXG4gICAgICB0aGlzLm1lbWJlck1hcC5zZXQocCBhcyBrZXlvZiBPYmplY3QzRCwgdmFsdWUpO1xuICAgICAgaWYgKHRoaXMub2JqUmVmKSB7XG4gICAgICAgIC8vIGFuZCBhcHBseSB0byB0aGUgcmVhbCBvYmplY3QgaWYgcHJlc2VudFxuICAgICAgICAodGhpcy5vYmpSZWYgYXMgYW55KVtwXSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFkZCA9ICguLi5vYmplY3Q6IE9iamVjdDNEW10pOiB0aGlzID0+IHtcbiAgICBpZiAodGhpcy5vYmpSZWYpIHtcbiAgICAgIHRoaXMub2JqUmVmLmFkZCguLi5vYmplY3QpO1xuICAgIH1cblxuICAgIHRoaXMuY2hpbGRyZW4ucHVzaCguLi5vYmplY3QpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgcmVtb3ZlID0gKC4uLm9iamVjdDogT2JqZWN0M0RbXSk6IHRoaXMgPT4ge1xuICAgIGlmICh0aGlzLm9ialJlZikge1xuICAgICAgdGhpcy5vYmpSZWYucmVtb3ZlKC4uLm9iamVjdCk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBvYmogb2Ygb2JqZWN0KSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZihvYmopO1xuICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgdGhpcy5jaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICBhcHBseVRvT2JqZWN0M0QgPSAob2JqUmVmOiBPYmplY3QzRCkgPT4ge1xuICAgIHRoaXMubWVtYmVyTWFwLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgIGNvbnN0IG1lbWJlciA9IChvYmpSZWYgYXMgYW55KVtrZXldO1xuICAgICAgaWYgKGlzU2V0dGFibGUobWVtYmVyKSkge1xuICAgICAgICBhcHBseVZhbHVlKG1lbWJlciwgdmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgKG9ialJlZiBhcyBhbnkpW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IG9ialJlZi5hZGQoY2hpbGQpKTtcblxuICAgIGlmICh0aGlzLm9ialJlZj8ucGFyZW50KSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLm9ialJlZj8ucGFyZW50O1xuICAgICAgcGFyZW50LnJlbW92ZSh0aGlzLm9ialJlZik7XG4gICAgICBwYXJlbnQuYWRkKG9ialJlZik7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBBZGRzIGEgbGlzdGVuZXIgdG8gYW4gZXZlbnQgdHlwZS5cbiAgICpcbiAgICogQHBhcmFtIHR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdG8gbGlzdGVuIHRvLlxuICAgKiBAcGFyYW0gbGlzdGVuZXIgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgaXMgZmlyZWQuXG4gICAqL1xuICBhZGRFdmVudExpc3RlbmVyID0gKHR5cGU6IHN0cmluZywgbGlzdGVuZXI6IChldmVudDogRXZlbnQpID0+IHZvaWQpOiB2b2lkID0+IHtcbiAgICBsZXQgYXJyID0gdGhpcy5ldmVudExpc3RlbmVyW3R5cGVdO1xuICAgIGlmICghYXJyKSB7XG4gICAgICBhcnIgPSBbXTtcbiAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lclt0eXBlXSA9IGFycjtcbiAgICB9XG5cbiAgICBhcnIucHVzaChsaXN0ZW5lcik7XG5cbiAgICBpZiAodGhpcy5vYmpSZWYpIHtcbiAgICAgIHRoaXMub2JqUmVmLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlcyBhIGxpc3RlbmVyIGZyb20gYW4gZXZlbnQgdHlwZS5cbiAgICpcbiAgICogQHBhcmFtIHR5cGUgVGhlIHR5cGUgb2YgdGhlIGxpc3RlbmVyIHRoYXQgZ2V0cyByZW1vdmVkLlxuICAgKiBAcGFyYW0gbGlzdGVuZXIgVGhlIGxpc3RlbmVyIGZ1bmN0aW9uIHRoYXQgZ2V0cyByZW1vdmVkLlxuICAgKi9cbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lciA9ICh0eXBlOiBzdHJpbmcsIGxpc3RlbmVyOiAoZXZlbnQ6IEV2ZW50KSA9PiB2b2lkKTogdm9pZCA9PiB7XG4gICAgY29uc3QgYXJyID0gdGhpcy5ldmVudExpc3RlbmVyW3R5cGVdO1xuICAgIGlmICghYXJyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaW5kZXggPSBhcnIuaW5kZXhPZihsaXN0ZW5lcik7XG4gICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgIGFyci5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMYXp5T2JqZWN0M0RQcm94eSBleHRlbmRzIE9iamVjdDNEIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICByZWFkb25seSBfX2lzUHJveHk/OiBib29sZWFuO1xuICBvYmpSZWY/OiBPYmplY3QzRDtcbiAgYXBwbHlUb09iamVjdDNEKHJlYWw6IE9iamVjdDNEKTogdm9pZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUxhenlPYmplY3QzRFByb3h5KCk6IExhenlPYmplY3QzRFByb3h5IHtcbiAgcmV0dXJuIG5ldyBQcm94eTxMYXp5T2JqZWN0M0RQcm94eT4obmV3IE9iamVjdDNEKCkgYXMgTGF6eU9iamVjdDNEUHJveHksIG5ldyBPYmplY3QzRFByb3h5SGFuZGxlcigpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzTGF6eU9iamVjdDNkUHJveHkob2JqZWN0OiBPYmplY3QzRCB8IExhenlPYmplY3QzRFByb3h5KTogb2JqZWN0IGlzIExhenlPYmplY3QzRFByb3h5IHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gIHJldHVybiAob2JqZWN0IGFzIExhenlPYmplY3QzRFByb3h5KS5fX2lzUHJveHkgPT09IHRydWUgJiYgKG9iamVjdCBhcyBMYXp5T2JqZWN0M0RQcm94eSkub2JqUmVmID09PSB1bmRlZmluZWQ7XG59XG4iXX0=