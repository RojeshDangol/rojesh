import { Component, EventEmitter, Input, Output } from '@angular/core';
import { ReplaySubject } from 'rxjs';
import { isLazyObject3dProxy } from './loaders/LazyObject3dProxy';
import { isDisposable } from './util';
import * as i0 from "@angular/core";
// eslint-disable-next-line @angular-eslint/component-class-suffix
export class ThWrapperBase {
    constructor() {
        this.autoAddToParent = true;
        this.autoDispose = true;
        // nothing to do
    }
    set objRef(ref) {
        this.applyObjRef(ref);
    }
    get objRef() {
        return this._objRef;
    }
    addToParent() {
        // nothing to do, implement it in a derived class
    }
    removeFromParent() {
        // nothing to do, implement it in a derived class
    }
    get onUpdate() {
        if (!this.updateEmitter) {
            this.updateEmitter = new EventEmitter();
        }
        return this.updateEmitter;
    }
    /**
     * emits the last assigned object ref
     */
    get objRef$() {
        if (!this._objRef$) {
            this._objRef$ = new ReplaySubject(1);
        }
        return this._objRef$;
    }
    ngOnInit() {
        if (!this.objRef) {
            this.objRef = this.createThreeInstance(this.args);
        }
    }
    // Override this
    getType() {
        throw new Error('derive me');
    }
    createThreeInstance(args) {
        if (Array.isArray(args)) {
            return new (this.getType())(...args);
        }
        else {
            return new (this.getType())(args);
        }
    }
    ngOnChanges(changes) {
        // console.log('on changes');
        if (this.objRef && !isLazyObject3dProxy(this.objRef)) {
            // the object is already set and it is no proxy
            // emit the changes
            this.emitPropertyChanges(changes);
            // TODO: request animation frame
            return;
        }
        if (changes.objRef?.currentValue) {
            this.objRef = changes.objRef?.currentValue;
        }
        else if (!this.objRef) {
            this.objRef = this.createThreeInstance(changes.args?.currentValue);
        }
        // eslint-disable-next-line guard-for-in
        for (const key in changes) {
            this[key] = changes[key].currentValue;
        }
        this.emitPropertyChanges(changes);
    }
    disposeObjRef() {
        if (isDisposable(this.objRef)) {
            this.objRef.dispose();
        }
    }
    ngOnDestroy() {
        this.removeFromParent();
        if (this.autoDispose) {
            this.disposeObjRef();
        }
    }
    applyObjRef(objRef) {
        if (this._objRef === objRef) {
            return;
        }
        this.removeFromParent();
        this._objRef = objRef;
        if (this.autoAddToParent) {
            this.addToParent();
        }
        this.emitObjRefChange();
    }
    emitObjRefChange() {
        // TODO only emit change if _objRef is no proxy,
        // and/or trigger emit over objRef event emitter
        if (this._objRef && !isLazyObject3dProxy(this._objRef)) {
            this._objRef.dispatchEvent?.({ type: 'loaded', object: this._objRef });
            if (this._objRef$) {
                this._objRef$.next(this._objRef);
            }
        }
    }
    emitPropertyChanges(changes) {
        this.objRef.dispatchEvent?.({ type: 'changes', changes });
        if (this.updateEmitter) {
            this.updateEmitter.next(changes);
        }
    }
}
ThWrapperBase.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: ThWrapperBase, deps: [], target: i0.ɵɵFactoryTarget.Component });
ThWrapperBase.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.0.2", type: ThWrapperBase, selector: "th-abs-wrapper", inputs: { autoAddToParent: "autoAddToParent", autoDispose: "autoDispose", objRef: "objRef", args: "args" }, outputs: { onUpdate: "onUpdate", objRef$: "objRef$" }, usesOnChanges: true, ngImport: i0, template: '', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: ThWrapperBase, decorators: [{
            type: Component,
            args: [{
                    selector: 'th-abs-wrapper',
                    template: ''
                }]
        }], ctorParameters: function () { return []; }, propDecorators: { autoAddToParent: [{
                type: Input
            }], autoDispose: [{
                type: Input
            }], objRef: [{
                type: Input
            }], args: [{
                type: Input
            }], onUpdate: [{
                type: Output
            }], objRef$: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGhXcmFwcGVyQmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC10aHJlZS9zcmMvbGliL1RoV3JhcHBlckJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFnQyxNQUFNLEVBQXVCLE1BQU0sZUFBZSxDQUFDO0FBQzFILE9BQU8sRUFBYyxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFakQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFbEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFFBQVEsQ0FBQzs7QUFNdEMsa0VBQWtFO0FBQ2xFLE1BQU0sT0FBTyxhQUFhO0lBc0J4QjtRQWpCTyxvQkFBZSxHQUFHLElBQUksQ0FBQztRQUd2QixnQkFBVyxHQUFHLElBQUksQ0FBQztRQWV4QixnQkFBZ0I7SUFDbEIsQ0FBQztJQWRELElBQ0ksTUFBTSxDQUFDLEdBQWtCO1FBQzNCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQUksTUFBTTtRQUNSLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBU0QsV0FBVztRQUNULGlEQUFpRDtJQUNuRCxDQUFDO0lBQ0QsZ0JBQWdCO1FBQ2QsaURBQWlEO0lBQ25ELENBQUM7SUFLRCxJQUNXLFFBQVE7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1NBQ3pDO1FBQ0QsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7T0FFRztJQUNILElBQ1csT0FBTztRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixJQUFJLENBQUMsUUFBUSxHQUFH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QUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ2xHLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ2xDO1NBQ0Y7SUFDSCxDQUFDO0lBRVMsbUJBQW1CLENBQUMsT0FBc0I7UUFDaEQsSUFBSSxDQUFDLE1BQXNDLENBQUMsYUFBYSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDNUYsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2xDO0lBQ0gsQ0FBQzs7MEdBOUlVLGFBQWE7OEZBQWIsYUFBYSw4T0FIZCxFQUFFOzJGQUdELGFBQWE7a0JBTHpCLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLGdCQUFnQjtvQkFDMUIsUUFBUSxFQUFFLEVBQUU7aUJBQ2I7MEVBT1EsZUFBZTtzQkFEckIsS0FBSztnQkFJQyxXQUFXO3NCQURqQixLQUFLO2dCQUlGLE1BQU07c0JBRFQsS0FBSztnQkF3QkMsSUFBSTtzQkFEVixLQUFLO2dCQUlLLFFBQVE7c0JBRGxCLE1BQU07Z0JBWUksT0FBTztzQkFEakIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzLCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBFdmVudERpc3BhdGNoZXIsIE9iamVjdDNEIH0gZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgaXNMYXp5T2JqZWN0M2RQcm94eSB9IGZyb20gJy4vbG9hZGVycy9MYXp5T2JqZWN0M2RQcm94eSc7XG5pbXBvcnQgeyBUaFdyYXBwZXJMaWZlQ3ljbGUgfSBmcm9tICcuL1RoV3JhcHBlckxpZmVDeWNsZSc7XG5pbXBvcnQgeyBpc0Rpc3Bvc2FibGUgfSBmcm9tICcuL3V0aWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0aC1hYnMtd3JhcHBlcicsXG4gIHRlbXBsYXRlOiAnJ1xufSlcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvY29tcG9uZW50LWNsYXNzLXN1ZmZpeFxuZXhwb3J0IGNsYXNzIFRoV3JhcHBlckJhc2U8VCwgQVJHUyA9IHVua25vd24+IGltcGxlbWVudHMgVGhXcmFwcGVyTGlmZUN5Y2xlLCBPbkNoYW5nZXMsIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgcHJvdGVjdGVkIF9vYmpSZWY/OiBUO1xuICBwcm90ZWN0ZWQgX29ialJlZiQ/OiBSZXBsYXlTdWJqZWN0PFQ+O1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBhdXRvQWRkVG9QYXJlbnQgPSB0cnVlO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBhdXRvRGlzcG9zZSA9IHRydWU7XG5cbiAgQElucHV0KClcbiAgc2V0IG9ialJlZihyZWY6IFQgfCB1bmRlZmluZWQpIHtcbiAgICB0aGlzLmFwcGx5T2JqUmVmKHJlZik7XG4gIH1cblxuICBnZXQgb2JqUmVmKCkge1xuICAgIHJldHVybiB0aGlzLl9vYmpSZWY7XG4gIH1cblxuICAvLyBlbWl0IHRoZSBjaGFuZ2VzXG4gIHByb3RlY3RlZCB1cGRhdGVFbWl0dGVyPzogRXZlbnRFbWl0dGVyPFNpbXBsZUNoYW5nZXM+O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIG5vdGhpbmcgdG8gZG9cbiAgfVxuXG4gIGFkZFRvUGFyZW50KCk6IHZvaWQge1xuICAgIC8vIG5vdGhpbmcgdG8gZG8sIGltcGxlbWVudCBpdCBpbiBhIGRlcml2ZWQgY2xhc3NcbiAgfVxuICByZW1vdmVGcm9tUGFyZW50KCk6IHZvaWQge1xuICAgIC8vIG5vdGhpbmcgdG8gZG8sIGltcGxlbWVudCBpdCBpbiBhIGRlcml2ZWQgY2xhc3NcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBhcmdzPzogQVJHUztcblxuICBAT3V0cHV0KClcbiAgcHVibGljIGdldCBvblVwZGF0ZSgpOiBPYnNlcnZhYmxlPFNpbXBsZUNoYW5nZXM+IHtcbiAgICBpZiAoIXRoaXMudXBkYXRlRW1pdHRlcikge1xuICAgICAgdGhpcy51cGRhdGVFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy51cGRhdGVFbWl0dGVyO1xuICB9XG5cbiAgLyoqXG4gICAqIGVtaXRzIHRoZSBsYXN0IGFzc2lnbmVkIG9iamVjdCByZWZcbiAgICovXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgZ2V0IG9ialJlZiQoKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgaWYgKCF0aGlzLl9vYmpSZWYkKSB7XG4gICAgICB0aGlzLl9vYmpSZWYkID0gbmV3IFJlcGxheVN1YmplY3QoMSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9vYmpSZWYkO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLm9ialJlZikge1xuICAgICAgdGhpcy5vYmpSZWYgPSB0aGlzLmNyZWF0ZVRocmVlSW5zdGFuY2UodGhpcy5hcmdzKTtcbiAgICB9XG4gIH1cblxuICAvLyBPdmVycmlkZSB0aGlzXG4gIHB1YmxpYyBnZXRUeXBlKCk6IFR5cGU8YW55PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdkZXJpdmUgbWUnKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUaHJlZUluc3RhbmNlKGFyZ3M/OiB1bmtub3duKSB7XG4gICAgaWYoQXJyYXkuaXNBcnJheShhcmdzKSkge1xuICAgICAgcmV0dXJuIG5ldyAodGhpcy5nZXRUeXBlKCkpKCAuLi4oYXJncyBhcyBhbnlbXSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3ICh0aGlzLmdldFR5cGUoKSkoYXJncyk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIC8vIGNvbnNvbGUubG9nKCdvbiBjaGFuZ2VzJyk7XG4gICAgaWYgKHRoaXMub2JqUmVmICYmICFpc0xhenlPYmplY3QzZFByb3h5KHRoaXMub2JqUmVmIGFzIGFueSkpIHtcbiAgICAgIC8vIHRoZSBvYmplY3QgaXMgYWxyZWFkeSBzZXQgYW5kIGl0IGlzIG5vIHByb3h5XG5cbiAgICAgIC8vIGVtaXQgdGhlIGNoYW5nZXNcbiAgICAgIHRoaXMuZW1pdFByb3BlcnR5Q2hhbmdlcyhjaGFuZ2VzKTtcblxuICAgICAgLy8gVE9ETzogcmVxdWVzdCBhbmltYXRpb24gZnJhbWVcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChjaGFuZ2VzLm9ialJlZj8uY3VycmVudFZhbHVlKSB7XG4gICAgICB0aGlzLm9ialJlZiA9IGNoYW5nZXMub2JqUmVmPy5jdXJyZW50VmFsdWU7XG4gICAgfSBlbHNlIGlmICghdGhpcy5vYmpSZWYpIHtcbiAgICAgIHRoaXMub2JqUmVmID0gdGhpcy5jcmVhdGVUaHJlZUluc3RhbmNlKGNoYW5nZXMuYXJncz8uY3VycmVudFZhbHVlKTtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZ3VhcmQtZm9yLWluXG4gICAgZm9yIChjb25zdCBrZXkgaW4gY2hhbmdlcykge1xuICAgICAgKHRoaXMgYXMgYW55KVtrZXldID0gY2hhbmdlc1trZXldLmN1cnJlbnRWYWx1ZTtcbiAgICB9XG4gICAgdGhpcy5lbWl0UHJvcGVydHlDaGFuZ2VzKGNoYW5nZXMpO1xuICB9XG5cbiAgcHVibGljIGRpc3Bvc2VPYmpSZWYoKSB7XG4gICAgaWYgKGlzRGlzcG9zYWJsZSh0aGlzLm9ialJlZikpIHtcbiAgICAgIHRoaXMub2JqUmVmLmRpc3Bvc2UoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnJlbW92ZUZyb21QYXJlbnQoKTtcblxuICAgIGlmICh0aGlzLmF1dG9EaXNwb3NlKSB7XG4gICAgICB0aGlzLmRpc3Bvc2VPYmpSZWYoKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgYXBwbHlPYmpSZWYob2JqUmVmOiBUIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHRoaXMuX29ialJlZiA9PT0gb2JqUmVmKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucmVtb3ZlRnJvbVBhcmVudCgpO1xuICAgIHRoaXMuX29ialJlZiA9IG9ialJlZjtcbiAgICBpZiAodGhpcy5hdXRvQWRkVG9QYXJlbnQpIHtcbiAgICAgIHRoaXMuYWRkVG9QYXJlbnQoKTtcbiAgICB9XG4gICAgdGhpcy5lbWl0T2JqUmVmQ2hhbmdlKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZW1pdE9ialJlZkNoYW5nZSgpIHtcbiAgICAvLyBUT0RPIG9ubHkgZW1pdCBjaGFuZ2UgaWYgX29ialJlZiBpcyBubyBwcm94eSxcbiAgICAvLyBhbmQvb3IgdHJpZ2dlciBlbWl0IG92ZXIgb2JqUmVmIGV2ZW50IGVtaXR0ZXJcbiAgICBpZiAodGhpcy5fb2JqUmVmICYmICFpc0xhenlPYmplY3QzZFByb3h5KHRoaXMuX29ialJlZiBhcyBhbnkpKSB7XG4gICAgICAoKHRoaXMuX29ialJlZiBhcyB1bmtub3duKSBhcyBPYmplY3QzRCkuZGlzcGF0Y2hFdmVudD8uKHsgdHlwZTogJ2xvYWRlZCcsIG9iamVjdDogdGhpcy5fb2JqUmVmIH0pO1xuICAgICAgaWYgKHRoaXMuX29ialJlZiQpIHtcbiAgICAgICAgdGhpcy5fb2JqUmVmJC5uZXh0KHRoaXMuX29ialJlZik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGVtaXRQcm9wZXJ0eUNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICgodGhpcy5vYmpSZWYgYXMgdW5rbm93bikgYXMgRXZlbnREaXNwYXRjaGVyKS5kaXNwYXRjaEV2ZW50Py4oeyB0eXBlOiAnY2hhbmdlcycsIGNoYW5nZXMgfSk7XG4gICAgaWYgKHRoaXMudXBkYXRlRW1pdHRlcikge1xuICAgICAgdGhpcy51cGRhdGVFbWl0dGVyLm5leHQoY2hhbmdlcyk7XG4gICAgfVxuICB9XG59XG4iXX0=