var _NgtStore_instances, _NgtStore_allReady$, _NgtStore_dimensions$, _NgtStore_init, _NgtStore_updateDimensions;
import { __classPrivateFieldGet } from "tslib";
import { ElementRef, Inject, Injectable } from '@angular/core';
import { selectSlice } from '@rx-angular/state';
import { map, Observable } from 'rxjs';
import * as THREE from 'three';
import { NGT_PERFORMANCE_OPTIONS } from '../di/performance';
import { NgtResize } from '../services/resize.service';
import { applyProps } from '../utils/apply-props';
import { calculateDpr } from '../utils/calculate-dpr';
import { isOrthographicCamera } from '../utils/is-orthographic';
import { EnhancedRxState, getActions } from './enhanced-rx-state';
import * as i0 from "@angular/core";
import * as i1 from "rxjs";
const position = new THREE.Vector3();
const defaultTarget = new THREE.Vector3();
export class NgtStore extends EnhancedRxState {
    constructor(performance, { nativeElement: canvasHost }, resizeResult$) {
        super();
        this.resizeResult$ = resizeResult$;
        _NgtStore_instances.add(this);
        _NgtStore_allReady$.set(this, this.select(selectSlice(['scene', 'camera', 'renderer', 'raycaster']), map(({ scene, camera, renderer, raycaster }) => !!scene && !!camera && !!renderer && !!raycaster)));
        _NgtStore_dimensions$.set(this, this.select(selectSlice(['size', 'viewport'])));
        this.actions = getActions();
        this.set({
            ready: false,
            vr: false,
            orthographic: false,
            flat: false,
            linear: false,
            size: {
                height: canvasHost.clientHeight,
                width: canvasHost.clientWidth,
            },
            mouse: new THREE.Vector2(),
            clock: new THREE.Clock(),
            frameloop: 'always',
            performance,
            controls: null,
            objects: {},
            dpr: 1,
            shadows: false,
            cameraOptions: {},
            glOptions: {},
            raycasterOptions: {},
            sceneOptions: {},
            viewport: {
                initialDpr: calculateDpr(this.get('dpr')),
                dpr: calculateDpr(this.get('dpr')),
                width: canvasHost.clientWidth,
                height: canvasHost.clientHeight,
                aspect: canvasHost.clientWidth / canvasHost.clientHeight,
                distance: 0,
                factor: 0,
                getCurrentViewport: (camera = this.get('camera'), target = defaultTarget, size = this.get('size')) => {
                    const { width, height } = size;
                    const aspect = width / height;
                    const distance = camera
                        .getWorldDirection(position)
                        .distanceTo(target);
                    if (isOrthographicCamera(camera)) {
                        return {
                            width: width / camera.zoom,
                            height: height / camera.zoom,
                            factor: 1,
                            distance,
                            aspect,
                        };
                    }
                    const fov = (camera.fov * Math.PI) / 180; // convert vertical fov to radians
                    const h = 2 * Math.tan(fov / 2) * distance; // height of viewport
                    const w = h * aspect; // width of viewport
                    return {
                        width: w,
                        height: h,
                        factor: width / w,
                        distance,
                        aspect,
                    };
                },
            },
        });
        this.connect('ready', __classPrivateFieldGet(this, _NgtStore_allReady$, "f"));
        this.connect('size', this.resizeResult$, (_, { width, height }) => ({
            width,
            height,
        }));
        this.connect('viewport', this.resizeResult$, ({ viewport }, { dpr }) => ({
            ...viewport,
            dpr,
        }));
        this.hold(__classPrivateFieldGet(this, _NgtStore_dimensions$, "f"), __classPrivateFieldGet(this, _NgtStore_instances, "m", _NgtStore_updateDimensions).bind(this));
        this.holdEffect(this.actions.canvasElement$, __classPrivateFieldGet(this, _NgtStore_instances, "m", _NgtStore_init).bind(this));
    }
}
_NgtStore_allReady$ = new WeakMap(), _NgtStore_dimensions$ = new WeakMap(), _NgtStore_instances = new WeakSet(), _NgtStore_init = function _NgtStore_init(canvasElement) {
    const { size, viewport, vr, linear, flat, orthographic } = this.get();
    const { shadows, glOptions, sceneOptions, cameraOptions, raycasterOptions, } = this.get();
    // Scene
    const scene = new THREE.Scene();
    applyProps(scene, sceneOptions);
    // Camera
    const isCamera = cameraOptions instanceof THREE.Camera;
    const camera = isCamera
        ? cameraOptions
        : orthographic
            ? new THREE.OrthographicCamera(0, 0, 0, 0, 0.1, 1000)
            : new THREE.PerspectiveCamera(75, size.width / size.height, 0.1, 1000);
    if (!isCamera) {
        camera.position.z = 5;
        if (cameraOptions) {
            applyProps(camera, cameraOptions);
            // Update projection matrix after applying props
            camera.updateProjectionMatrix();
        }
        // look at center if initial rotation isn't set
        if (!cameraOptions?.rotation)
            camera.lookAt(0, 0, 0);
    }
    // Raycaster
    const raycaster = new THREE.Raycaster();
    const { params, ...options } = raycasterOptions || {};
    applyProps(raycaster, {
        enabled: true,
        ...options,
        params: { ...raycaster.params, ...params },
    });
    // Renderer
    const customRenderer = (typeof glOptions === 'function' ? glOptions(canvasElement) : glOptions);
    // userland custom renderer, assign as-is
    if (!!customRenderer?.render) {
        this.set({
            renderer: customRenderer,
            scene,
            camera,
            raycaster: raycaster,
        });
        return;
    }
    const renderer = new THREE.WebGLRenderer({
        powerPreference: 'high-performance',
        canvas: canvasElement,
        antialias: true,
        alpha: true,
        ...(glOptions || {}),
    });
    if (glOptions) {
        applyProps(renderer, glOptions);
    }
    if (shadows) {
        renderer.shadowMap.enabled = true;
        if (typeof shadows === 'object') {
            Object.assign(renderer.shadowMap, shadows);
        }
        else {
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        }
    }
    if (!linear) {
        // auto color management
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
    }
    else {
        renderer.outputEncoding = THREE.LinearEncoding;
    }
    if (flat) {
        renderer.toneMapping = THREE.NoToneMapping;
    }
    renderer.setClearAlpha(0);
    renderer.setPixelRatio(calculateDpr(viewport.dpr));
    renderer.setSize(size.width, size.height);
    if (vr) {
        renderer.xr.enabled = true;
    }
    this.set({
        renderer,
        scene,
        camera,
        raycaster: raycaster,
    });
    return () => {
        const { renderer, vr } = this.get();
        if (renderer) {
            renderer.renderLists.dispose();
            renderer.forceContextLoss();
            if (vr) {
                renderer.setAnimationLoop(null);
            }
        }
    };
}, _NgtStore_updateDimensions = function _NgtStore_updateDimensions({ size, viewport, }) {
    const { camera, renderer, ready, cameraOptions } = this.get();
    if (ready) {
        // update renderer
        renderer.setPixelRatio(viewport.dpr);
        renderer.setSize(size.width, size.height);
        // leave the userland camera alone
        if (cameraOptions instanceof THREE.Camera)
            return;
        if (isOrthographicCamera(camera)) {
            camera.left = size.width / -2;
            camera.right = size.width / 2;
            camera.top = size.height / 2;
            camera.bottom = size.height / -2;
        }
        else {
            camera.aspect = size.width / size.height;
        }
        camera.updateProjectionMatrix();
        // https://github.com/pmndrs/react-three-fiber/issues/178
        // Update matrix world since the renderer is a frame late
        camera.updateMatrixWorld();
    }
};
NgtStore.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtStore, deps: [{ token: NGT_PERFORMANCE_OPTIONS }, { token: i0.ElementRef }, { token: NgtResize }], target: i0.ɵɵFactoryTarget.Injectable });
NgtStore.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtStore });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtStore, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [NGT_PERFORMANCE_OPTIONS]
                }] }, { type: i0.ElementRef }, { type: i1.Observable, decorators: [{
                    type: Inject,
                    args: [NgtResize]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9saWIvc3RvcmVzL3N0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFtQixNQUFNLDRCQUE0QixDQUFDO0FBVXhFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7O0FBRWxFLE1BQU0sUUFBUSxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3JDLE1BQU0sYUFBYSxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBRzFDLE1BQU0sT0FBTyxRQUFTLFNBQVEsZUFBeUI7SUFhckQsWUFDbUMsV0FBMkIsRUFDNUQsRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUEyQixFQUU5QyxhQUEwQztRQUVsRCxLQUFLLEVBQUUsQ0FBQztRQUZBLGtCQUFhLEdBQWIsYUFBYSxDQUE2Qjs7UUFoQnBELDhCQUFhLElBQUksQ0FBQyxNQUFNLENBQ3RCLFdBQVcsQ0FBQyxDQUFD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QUUsQ0FBQztLQUM1QjtBQUNILENBQUM7cUdBM1BVLFFBQVEsa0JBY1QsdUJBQXVCLHVDQUV2QixTQUFTO3lHQWhCUixRQUFROzJGQUFSLFFBQVE7a0JBRHBCLFVBQVU7OzBCQWVOLE1BQU07MkJBQUMsdUJBQXVCOzswQkFFOUIsTUFBTTsyQkFBQyxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWxlbWVudFJlZiwgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBzZWxlY3RTbGljZSB9IGZyb20gJ0ByeC1hbmd1bGFyL3N0YXRlJztcbmltcG9ydCB7IG1hcCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgTkdUX1BFUkZPUk1BTkNFX09QVElPTlMgfSBmcm9tICcuLi9kaS9wZXJmb3JtYW5jZSc7XG5pbXBvcnQgeyBOZ3RSZXNpemUsIE5ndFJlc2l6ZVJlc3VsdCB9IGZyb20gJy4uL3NlcnZpY2VzL3Jlc2l6ZS5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIE5ndEluc3RhbmNlLFxuICBOZ3RQZXJmb3JtYW5jZSxcbiAgTmd0UmF5Y2FzdGVyLFxuICBOZ3RTaXplLFxuICBOZ3RTdGF0ZSxcbiAgTmd0Vmlld3BvcnQsXG4gIFVua25vd25SZWNvcmQsXG59IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IGFwcGx5UHJvcHMgfSBmcm9tICcuLi91dGlscy9hcHBseS1wcm9wcyc7XG5pbXBvcnQgeyBjYWxjdWxhdGVEcHIgfSBmcm9tICcuLi91dGlscy9jYWxjdWxhdGUtZHByJztcbmltcG9ydCB7IGlzT3J0aG9ncmFwaGljQ2FtZXJhIH0gZnJvbSAnLi4vdXRpbHMvaXMtb3J0aG9ncmFwaGljJztcbmltcG9ydCB7IEVuaGFuY2VkUnhTdGF0ZSwgZ2V0QWN0aW9ucyB9IGZyb20gJy4vZW5oYW5jZWQtcngtc3RhdGUnO1xuXG5jb25zdCBwb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XG5jb25zdCBkZWZhdWx0VGFyZ2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5ndFN0b3JlIGV4dGVuZHMgRW5oYW5jZWRSeFN0YXRlPE5ndFN0YXRlPiB7XG4gICNhbGxSZWFkeSQgPSB0aGlzLnNlbGVjdChcbiAgICBzZWxlY3RTbGljZShbJ3NjZW5lJywgJ2NhbWVyYScsICdyZW5kZXJlcicsICdyYXljYXN0ZXInXSksXG4gICAgbWFwKFxuICAgICAgKHsgc2NlbmUsIGNhbWVyYSwgcmVuZGVyZXIsIHJheWNhc3RlciB9KSA9PlxuICAgICAgICAhIXNjZW5lICYmICEhY2FtZXJhICYmICEhcmVuZGVyZXIgJiYgISFyYXljYXN0ZXJcbiAgICApXG4gICk7XG5cbiAgI2RpbWVuc2lvbnMkID0gdGhpcy5zZWxlY3Qoc2VsZWN0U2xpY2UoWydzaXplJywgJ3ZpZXdwb3J0J10pKTtcblxuICBhY3Rpb25zID0gZ2V0QWN0aW9uczx7IGNhbnZhc0VsZW1lbnQ6IEhUTUxDYW52YXNFbGVtZW50IH0+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChOR1RfUEVSRk9STUFOQ0VfT1BUSU9OUykgcGVyZm9ybWFuY2U6IE5ndFBlcmZvcm1hbmNlLFxuICAgIHsgbmF0aXZlRWxlbWVudDogY2FudmFzSG9zdCB9OiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PixcbiAgICBASW5qZWN0KE5ndFJlc2l6ZSlcbiAgICBwcml2YXRlIHJlc2l6ZVJlc3VsdCQ6IE9ic2VydmFibGU8Tmd0UmVzaXplUmVzdWx0PlxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuc2V0KHtcbiAgICAgIHJlYWR5OiBmYWxzZSxcbiAgICAgIHZyOiBmYWxzZSxcbiAgICAgIG9ydGhvZ3JhcGhpYzogZmFsc2UsXG4gICAgICBmbGF0OiBmYWxzZSxcbiAgICAgIGxpbmVhcjogZmFsc2UsXG4gICAgICBzaXplOiB7XG4gICAgICAgIGhlaWdodDogY2FudmFzSG9zdC5jbGllbnRIZWlnaHQsXG4gICAgICAgIHdpZHRoOiBjYW52YXNIb3N0LmNsaWVudFdpZHRoLFxuICAgICAgfSxcbiAgICAgIG1vdXNlOiBuZXcgVEhSRUUuVmVjdG9yMigpLFxuICAgICAgY2xvY2s6IG5ldyBUSFJFRS5DbG9jaygpLFxuICAgICAgZnJhbWVsb29wOiAnYWx3YXlzJyxcbiAgICAgIHBlcmZvcm1hbmNlLFxuICAgICAgY29udHJvbHM6IG51bGwsXG4gICAgICBvYmplY3RzOiB7fSxcbiAgICAgIGRwcjogMSxcbiAgICAgIHNoYWRvd3M6IGZhbHNlLFxuICAgICAgY2FtZXJhT3B0aW9uczoge30sXG4gICAgICBnbE9wdGlvbnM6IHt9LFxuICAgICAgcmF5Y2FzdGVyT3B0aW9uczoge30sXG4gICAgICBzY2VuZU9wdGlvbnM6IHt9LFxuICAgICAgdmlld3BvcnQ6IHtcbiAgICAgICAgaW5pdGlhbERwcjogY2FsY3VsYXRlRHByKHRoaXMuZ2V0KCdkcHInKSksXG4gICAgICAgIGRwcjogY2FsY3VsYXRlRHByKHRoaXMuZ2V0KCdkcHInKSksXG4gICAgICAgIHdpZHRoOiBjYW52YXNIb3N0LmNsaWVudFdpZHRoLFxuICAgICAgICBoZWlnaHQ6IGNhbnZhc0hvc3QuY2xpZW50SGVpZ2h0LFxuICAgICAgICBhc3BlY3Q6IGNhbnZhc0hvc3QuY2xpZW50V2lkdGggLyBjYW52YXNIb3N0LmNsaWVudEhlaWdodCxcbiAgICAgICAgZGlzdGFuY2U6IDAsXG4gICAgICAgIGZhY3RvcjogMCxcbiAgICAgICAgZ2V0Q3VycmVudFZpZXdwb3J0OiAoXG4gICAgICAgICAgY2FtZXJhID0gdGhpcy5nZXQoJ2NhbWVyYScpLFxuICAgICAgICAgIHRhcmdldCA9IGRlZmF1bHRUYXJnZXQsXG4gICAgICAgICAgc2l6ZSA9IHRoaXMuZ2V0KCdzaXplJylcbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBzaXplO1xuICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpZHRoIC8gaGVpZ2h0O1xuICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gY2FtZXJhXG4gICAgICAgICAgICAuZ2V0V29ybGREaXJlY3Rpb24ocG9zaXRpb24pXG4gICAgICAgICAgICAuZGlzdGFuY2VUbyh0YXJnZXQpO1xuICAgICAgICAgIGlmIChpc09ydGhvZ3JhcGhpY0NhbWVyYShjYW1lcmEpKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICB3aWR0aDogd2lkdGggLyBjYW1lcmEuem9vbSxcbiAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQgLyBjYW1lcmEuem9vbSxcbiAgICAgICAgICAgICAgZmFjdG9yOiAxLFxuICAgICAgICAgICAgICBkaXN0YW5jZSxcbiAgICAgICAgICAgICAgYXNwZWN0LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBmb3YgPSAoY2FtZXJhLmZvdiAqIE1hdGguUEkpIC8gMTgwOyAvLyBjb252ZXJ0IHZlcnRpY2FsIGZvdiB0byByYWRpYW5zXG4gICAgICAgICAgY29uc3QgaCA9IDIgKiBNYXRoLnRhbihmb3YgLyAyKSAqIGRpc3RhbmNlOyAvLyBoZWlnaHQgb2Ygdmlld3BvcnRcbiAgICAgICAgICBjb25zdCB3ID0gaCAqIGFzcGVjdDsgLy8gd2lkdGggb2Ygdmlld3BvcnRcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgd2lkdGg6IHcsXG4gICAgICAgICAgICBoZWlnaHQ6IGgsXG4gICAgICAgICAgICBmYWN0b3I6IHdpZHRoIC8gdyxcbiAgICAgICAgICAgIGRpc3RhbmNlLFxuICAgICAgICAgICAgYXNwZWN0LFxuICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5jb25uZWN0KCdyZWFkeScsIHRoaXMuI2FsbFJlYWR5JCk7XG4gICAgdGhpcy5jb25uZWN0KCdzaXplJywgdGhpcy5yZXNpemVSZXN1bHQkLCAoXywgeyB3aWR0aCwgaGVpZ2h0IH0pID0+ICh7XG4gICAgICB3aWR0aCxcbiAgICAgIGhlaWdodCxcbiAgICB9KSk7XG4gICAgdGhpcy5jb25uZWN0KCd2aWV3cG9ydCcsIHRoaXMucmVzaXplUmVzdWx0JCwgKHsgdmlld3BvcnQgfSwgeyBkcHIgfSkgPT4gKHtcbiAgICAgIC4uLnZpZXdwb3J0LFxuICAgICAgZHByLFxuICAgIH0pKTtcblxuICAgIHRoaXMuaG9sZCh0aGlzLiNkaW1lbnNpb25zJCwgdGhpcy4jdXBkYXRlRGltZW5zaW9ucy5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLmhvbGRFZmZlY3QodGhpcy5hY3Rpb25zLmNhbnZhc0VsZW1lbnQkLCB0aGlzLiNpbml0LmJpbmQodGhpcykpO1xuICB9XG5cbiAgI2luaXQoY2FudmFzRWxlbWVudDogSFRNTENhbnZhc0VsZW1lbnQpIHtcbiAgICBjb25zdCB7IHNpemUsIHZpZXdwb3J0LCB2ciwgbGluZWFyLCBmbGF0LCBvcnRob2dyYXBoaWMgfSA9IHRoaXMuZ2V0KCk7XG4gICAgY29uc3Qge1xuICAgICAgc2hhZG93cyxcbiAgICAgIGdsT3B0aW9ucyxcbiAgICAgIHNjZW5lT3B0aW9ucyxcbiAgICAgIGNhbWVyYU9wdGlvbnMsXG4gICAgICByYXljYXN0ZXJPcHRpb25zLFxuICAgIH0gPSB0aGlzLmdldCgpO1xuXG4gICAgLy8gU2NlbmVcbiAgICBjb25zdCBzY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xuICAgIGFwcGx5UHJvcHMoc2NlbmUsIHNjZW5lT3B0aW9ucyBhcyBVbmtub3duUmVjb3JkKTtcblxuICAgIC8vIENhbWVyYVxuICAgIGNvbnN0IGlzQ2FtZXJhID0gY2FtZXJhT3B0aW9ucyBpbnN0YW5jZW9mIFRIUkVFLkNhbWVyYTtcbiAgICBjb25zdCBjYW1lcmEgPSBpc0NhbWVyYVxuICAgICAgPyBjYW1lcmFPcHRpb25zXG4gICAgICA6IG9ydGhvZ3JhcGhpY1xuICAgICAgPyBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKDAsIDAsIDAsIDAsIDAuMSwgMTAwMClcbiAgICAgIDogbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDc1LCBzaXplLndpZHRoIC8gc2l6ZS5oZWlnaHQsIDAuMSwgMTAwMCk7XG5cbiAgICBpZiAoIWlzQ2FtZXJhKSB7XG4gICAgICBjYW1lcmEucG9zaXRpb24ueiA9IDU7XG4gICAgICBpZiAoY2FtZXJhT3B0aW9ucykge1xuICAgICAgICBhcHBseVByb3BzKGNhbWVyYSwgY2FtZXJhT3B0aW9ucyBhcyBVbmtub3duUmVjb3JkKTtcbiAgICAgICAgLy8gVXBkYXRlIHByb2plY3Rpb24gbWF0cml4IGFmdGVyIGFwcGx5aW5nIHByb3BzXG4gICAgICAgIGNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgICB9XG4gICAgICAvLyBsb29rIGF0IGNlbnRlciBpZiBpbml0aWFsIHJvdGF0aW9uIGlzbid0IHNldFxuICAgICAgaWYgKCFjYW1lcmFPcHRpb25zPy5yb3RhdGlvbikgY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTtcbiAgICB9XG5cbiAgICAvLyBSYXljYXN0ZXJcbiAgICBjb25zdCByYXljYXN0ZXIgPSBuZXcgVEhSRUUuUmF5Y2FzdGVyKCk7XG4gICAgY29uc3QgeyBwYXJhbXMsIC4uLm9wdGlvbnMgfSA9IHJheWNhc3Rlck9wdGlvbnMgfHwge307XG4gICAgYXBwbHlQcm9wcyhyYXljYXN0ZXIgYXMgdW5rbm93biBhcyBOZ3RJbnN0YW5jZSwge1xuICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgICBwYXJhbXM6IHsgLi4ucmF5Y2FzdGVyLnBhcmFtcywgLi4ucGFyYW1zIH0sXG4gICAgfSk7XG5cbiAgICAvLyBSZW5kZXJlclxuICAgIGNvbnN0IGN1c3RvbVJlbmRlcmVyID0gKFxuICAgICAgdHlwZW9mIGdsT3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJyA/IGdsT3B0aW9ucyhjYW52YXNFbGVtZW50KSA6IGdsT3B0aW9uc1xuICAgICkgYXMgVEhSRUUuV2ViR0xSZW5kZXJlcjtcblxuICAgIC8vIHVzZXJsYW5kIGN1c3RvbSByZW5kZXJlciwgYXNzaWduIGFzLWlzXG4gICAgaWYgKCEhY3VzdG9tUmVuZGVyZXI/LnJlbmRlcikge1xuICAgICAgdGhpcy5zZXQoe1xuICAgICAgICByZW5kZXJlcjogY3VzdG9tUmVuZGVyZXIsXG4gICAgICAgIHNjZW5lLFxuICAgICAgICBjYW1lcmEsXG4gICAgICAgIHJheWNhc3RlcjogcmF5Y2FzdGVyIGFzIE5ndFJheWNhc3RlcixcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHJlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoe1xuICAgICAgcG93ZXJQcmVmZXJlbmNlOiAnaGlnaC1wZXJmb3JtYW5jZScsXG4gICAgICBjYW52YXM6IGNhbnZhc0VsZW1lbnQsXG4gICAgICBhbnRpYWxpYXM6IHRydWUsXG4gICAgICBhbHBoYTogdHJ1ZSxcbiAgICAgIC4uLihnbE9wdGlvbnMgfHwge30pLFxuICAgIH0pO1xuXG4gICAgaWYgKGdsT3B0aW9ucykge1xuICAgICAgYXBwbHlQcm9wcyhcbiAgICAgICAgcmVuZGVyZXIgYXMgdW5rbm93biBhcyBOZ3RJbnN0YW5jZSxcbiAgICAgICAgZ2xPcHRpb25zIGFzIFVua25vd25SZWNvcmRcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHNoYWRvd3MpIHtcbiAgICAgIHJlbmRlcmVyLnNoYWRvd01hcC5lbmFibGVkID0gdHJ1ZTtcbiAgICAgIGlmICh0eXBlb2Ygc2hhZG93cyA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihyZW5kZXJlci5zaGFkb3dNYXAsIHNoYWRvd3MpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVuZGVyZXIuc2hhZG93TWFwLnR5cGUgPSBUSFJFRS5QQ0ZTb2Z0U2hhZG93TWFwO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghbGluZWFyKSB7XG4gICAgICAvLyBhdXRvIGNvbG9yIG1hbmFnZW1lbnRcbiAgICAgIHJlbmRlcmVyLnRvbmVNYXBwaW5nID0gVEhSRUUuQUNFU0ZpbG1pY1RvbmVNYXBwaW5nO1xuICAgICAgcmVuZGVyZXIub3V0cHV0RW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlbmRlcmVyLm91dHB1dEVuY29kaW5nID0gVEhSRUUuTGluZWFyRW5jb2Rpbmc7XG4gICAgfVxuXG4gICAgaWYgKGZsYXQpIHtcbiAgICAgIHJlbmRlcmVyLnRvbmVNYXBwaW5nID0gVEhSRUUuTm9Ub25lTWFwcGluZztcbiAgICB9XG5cbiAgICByZW5kZXJlci5zZXRDbGVhckFscGhhKDApO1xuICAgIHJlbmRlcmVyLnNldFBpeGVsUmF0aW8oY2FsY3VsYXRlRHByKHZpZXdwb3J0LmRwcikpO1xuICAgIHJlbmRlcmVyLnNldFNpemUoc2l6ZS53aWR0aCwgc2l6ZS5oZWlnaHQpO1xuXG4gICAgaWYgKHZyKSB7XG4gICAgICByZW5kZXJlci54ci5lbmFibGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB0aGlzLnNldCh7XG4gICAgICByZW5kZXJlcixcbiAgICAgIHNjZW5lLFxuICAgICAgY2FtZXJhLFxuICAgICAgcmF5Y2FzdGVyOiByYXljYXN0ZXIgYXMgTmd0UmF5Y2FzdGVyLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcmVuZGVyZXIsIHZyIH0gPSB0aGlzLmdldCgpO1xuICAgICAgaWYgKHJlbmRlcmVyKSB7XG4gICAgICAgIHJlbmRlcmVyLnJlbmRlckxpc3RzLmRpc3Bvc2UoKTtcbiAgICAgICAgcmVuZGVyZXIuZm9yY2VDb250ZXh0TG9zcygpO1xuXG4gICAgICAgIGlmICh2cikge1xuICAgICAgICAgIHJlbmRlcmVyLnNldEFuaW1hdGlvbkxvb3AobnVsbCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgI3VwZGF0ZURpbWVuc2lvbnMoe1xuICAgIHNpemUsXG4gICAgdmlld3BvcnQsXG4gIH06IHtcbiAgICBzaXplOiBOZ3RTaXplO1xuICAgIHZpZXdwb3J0OiBOZ3RWaWV3cG9ydDtcbiAgfSkge1xuICAgIGNvbnN0IHsgY2FtZXJhLCByZW5kZXJlciwgcmVhZHksIGNhbWVyYU9wdGlvbnMgfSA9IHRoaXMuZ2V0KCk7XG5cbiAgICBpZiAocmVhZHkpIHtcbiAgICAgIC8vIHVwZGF0ZSByZW5kZXJlclxuICAgICAgcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbyh2aWV3cG9ydC5kcHIpO1xuICAgICAgcmVuZGVyZXIuc2V0U2l6ZShzaXplLndpZHRoLCBzaXplLmhlaWdodCk7XG5cbiAgICAgIC8vIGxlYXZlIHRoZSB1c2VybGFuZCBjYW1lcmEgYWxvbmVcbiAgICAgIGlmIChjYW1lcmFPcHRpb25zIGluc3RhbmNlb2YgVEhSRUUuQ2FtZXJhKSByZXR1cm47XG5cbiAgICAgIGlmIChpc09ydGhvZ3JhcGhpY0NhbWVyYShjYW1lcmEpKSB7XG4gICAgICAgIGNhbWVyYS5sZWZ0ID0gc2l6ZS53aWR0aCAvIC0yO1xuICAgICAgICBjYW1lcmEucmlnaHQgPSBzaXplLndpZHRoIC8gMjtcbiAgICAgICAgY2FtZXJhLnRvcCA9IHNpemUuaGVpZ2h0IC8gMjtcbiAgICAgICAgY2FtZXJhLmJvdHRvbSA9IHNpemUuaGVpZ2h0IC8gLTI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYW1lcmEuYXNwZWN0ID0gc2l6ZS53aWR0aCAvIHNpemUuaGVpZ2h0O1xuICAgICAgfVxuXG4gICAgICBjYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpO1xuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BtbmRycy9yZWFjdC10aHJlZS1maWJlci9pc3N1ZXMvMTc4XG4gICAgICAvLyBVcGRhdGUgbWF0cml4IHdvcmxkIHNpbmNlIHRoZSByZW5kZXJlciBpcyBhIGZyYW1lIGxhdGVcbiAgICAgIGNhbWVyYS51cGRhdGVNYXRyaXhXb3JsZCgpO1xuICAgIH1cbiAgfVxufVxuIl19