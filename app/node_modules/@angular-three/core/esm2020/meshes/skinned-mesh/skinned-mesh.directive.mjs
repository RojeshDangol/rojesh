var _NgtSkeleton_skeleton, _NgtBone_bone;
import { __classPrivateFieldGet, __classPrivateFieldSet } from "tslib";
import { NGT_MATERIAL_GEOMETRY_CONTROLLER_PROVIDER, NGT_OBJECT_CONTROLLER_PROVIDER, NGT_OBJECT_INPUTS_WATCHED_CONTROLLER, NGT_OBJECT_TYPE, NGT_OBJECT_WATCHED_CONTROLLER, NgtCommonMesh, NgtObject3dController, NgtObject3dInputsController, } from '@angular-three/core';
import { Directive, EventEmitter, Inject, Input, NgModule, NgZone, Optional, Output, } from '@angular/core';
import { requestAnimationFrame } from '@rx-angular/cdk/zone-less';
import * as THREE from 'three';
import * as i0 from "@angular/core";
import * as i1 from "@angular-three/core";
export class NgtSkinnedMesh extends NgtCommonMesh {
    set args(v) {
        if (this.materialGeometryController) {
            this.materialGeometryController.meshArgs = v;
        }
    }
}
NgtSkinnedMesh.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkinnedMesh, deps: null, target: i0.ɵɵFactoryTarget.Directive });
NgtSkinnedMesh.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.0.3", type: NgtSkinnedMesh, selector: "ngt-skinned-mesh", inputs: { args: "args", bindMatrix: "bindMatrix", bindMode: "bindMode" }, providers: [
        { provide: NgtCommonMesh, useExisting: NgtSkinnedMesh },
        NGT_MATERIAL_GEOMETRY_CONTROLLER_PROVIDER,
        { provide: NGT_OBJECT_TYPE, useValue: THREE.SkinnedMesh },
    ], exportAs: ["ngtSkinnedMesh"], usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkinnedMesh, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-skinned-mesh',
                    exportAs: 'ngtSkinnedMesh',
                    providers: [
                        { provide: NgtCommonMesh, useExisting: NgtSkinnedMesh },
                        NGT_MATERIAL_GEOMETRY_CONTROLLER_PROVIDER,
                        { provide: NGT_OBJECT_TYPE, useValue: THREE.SkinnedMesh },
                    ],
                }]
        }], propDecorators: { args: [{
                type: Input
            }], bindMatrix: [{
                type: Input
            }], bindMode: [{
                type: Input
            }] } });
export class NgtSkeleton {
    constructor(ngZone, skinnedMesh) {
        this.ngZone = ngZone;
        this.skinnedMesh = skinnedMesh;
        this.ready = new EventEmitter();
        _NgtSkeleton_skeleton.set(this, void 0);
        if (!skinnedMesh) {
            throw new Error('ngt-skeleton must be used within a ngt-skinned-mesh');
        }
    }
    get skeleton() {
        return __classPrivateFieldGet(this, _NgtSkeleton_skeleton, "f");
    }
    ngOnInit() {
        this.ngZone.runOutsideAngular(() => {
            const boneInverses = this.boneInverses
                ? this.boneInverses.map((threeMaxtrix) => {
                    if (threeMaxtrix instanceof THREE.Matrix4)
                        return threeMaxtrix;
                    return new THREE.Matrix4().set(...threeMaxtrix);
                })
                : undefined;
            __classPrivateFieldSet(this, _NgtSkeleton_skeleton, new THREE.Skeleton([], boneInverses), "f");
            this.ready.emit();
            if (this.skinnedMesh) {
                const bindMatrix = this.skinnedMesh
                    .bindMatrix
                    ? this.skinnedMesh.bindMatrix instanceof THREE.Matrix4
                        ? this.skinnedMesh.bindMatrix
                        : new THREE.Matrix4().set(...this.skinnedMesh.bindMatrix)
                    : undefined;
                this.skinnedMesh.mesh.bind(this.skeleton, bindMatrix);
            }
        });
    }
}
_NgtSkeleton_skeleton = new WeakMap();
NgtSkeleton.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkeleton, deps: [{ token: i0.NgZone }, { token: NgtSkinnedMesh, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
NgtSkeleton.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.0.3", type: NgtSkeleton, selector: "ngt-skeleton", inputs: { boneInverses: "boneInverses" }, outputs: { ready: "ready" }, exportAs: ["ngtSkeleton"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkeleton, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-skeleton',
                    exportAs: 'ngtSkeleton',
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: NgtSkinnedMesh, decorators: [{
                    type: Optional
                }] }]; }, propDecorators: { boneInverses: [{
                type: Input
            }], ready: [{
                type: Output
            }] } });
export class NgtBone {
    constructor(objectController, objectInputsController, ngZone, parentSkinnedMesh, parentSkeleton) {
        this.objectController = objectController;
        this.objectInputsController = objectInputsController;
        this.ngZone = ngZone;
        this.parentSkinnedMesh = parentSkinnedMesh;
        this.parentSkeleton = parentSkeleton;
        _NgtBone_bone.set(this, void 0);
        if (!parentSkinnedMesh) {
            throw new Error('ngt-bone must be used within a ngt-skinned-mesh');
        }
        objectInputsController.appendTo = parentSkinnedMesh.mesh;
        objectController.initFn = () => {
            __classPrivateFieldSet(this, _NgtBone_bone, new THREE.Bone(), "f");
            return __classPrivateFieldGet(this, _NgtBone_bone, "f");
        };
    }
    get bone() {
        return __classPrivateFieldGet(this, _NgtBone_bone, "f");
    }
    ngOnInit() {
        this.ngZone.runOutsideAngular(() => {
            this.objectController.init();
            requestAnimationFrame(() => {
                if (this.parentSkeleton && this.parentSkeleton.skeleton) {
                    this.parentSkeleton.skeleton.bones.push(this.bone);
                }
            });
        });
    }
}
_NgtBone_bone = new WeakMap();
NgtBone.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtBone, deps: [{ token: NGT_OBJECT_WATCHED_CONTROLLER }, { token: NGT_OBJECT_INPUTS_WATCHED_CONTROLLER }, { token: i0.NgZone }, { token: NgtSkinnedMesh, optional: true }, { token: NgtSkeleton, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
NgtBone.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.0.3", type: NgtBone, selector: "ngt-bone", providers: [NGT_OBJECT_CONTROLLER_PROVIDER], exportAs: ["ngtBone"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtBone, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-bone',
                    exportAs: 'ngtBone',
                    providers: [NGT_OBJECT_CONTROLLER_PROVIDER],
                }]
        }], ctorParameters: function () { return [{ type: i1.NgtObject3dController, decorators: [{
                    type: Inject,
                    args: [NGT_OBJECT_WATCHED_CONTROLLER]
                }] }, { type: i1.NgtObject3dInputsController, decorators: [{
                    type: Inject,
                    args: [NGT_OBJECT_INPUTS_WATCHED_CONTROLLER]
                }] }, { type: i0.NgZone }, { type: NgtSkinnedMesh, decorators: [{
                    type: Optional
                }] }, { type: NgtSkeleton, decorators: [{
                    type: Optional
                }] }]; } });
export class NgtSkinnedMeshModule {
}
NgtSkinnedMeshModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkinnedMeshModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });
NgtSkinnedMeshModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkinnedMeshModule, declarations: [NgtSkinnedMesh, NgtBone, NgtSkeleton], exports: [NgtSkinnedMesh, NgtBone, NgtSkeleton] });
NgtSkinnedMeshModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkinnedMeshModule });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgtSkinnedMeshModule, decorators: [{
            type: NgModule,
            args: [{
                    declarations: [NgtSkinnedMesh, NgtBone, NgtSkeleton],
                    exports: [NgtSkinnedMesh, NgtBone, NgtSkeleton],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2tpbm5lZC1tZXNoLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvcmUvbWVzaGVzL3NyYy9za2lubmVkLW1lc2gvc2tpbm5lZC1tZXNoLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sRUFDTCx5Q0FBeUMsRUFDekMsOEJBQThCLEVBQzlCLG9DQUFvQyxFQUNwQyxlQUFlLEVBQ2YsNkJBQTZCLEVBQzdCLGFBQWEsRUFFYixxQkFBcUIsRUFDckIsMkJBQTJCLEdBQzVCLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFDTCxRQUFRLEVBQ1IsTUFBTSxFQUVOLFFBQVEsRUFDUixNQUFNLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7OztBQVcvQixNQUFNLE9BQU8sY0FBZSxTQUFRLGFBQWdDO0lBQ2xFLElBQWEsSUFBSSxDQUFDLENBQVk7UUFDNUIsSUFBSSxJQUFJLENBQUMsMEJBQTBCLEVBQUU7WUFDbkMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7U0FDOUM7SUFDSCxDQUFDOzsyR0FMVSxjQUFjOytGQUFkLGNBQWMscUhBTmQ7UUFDVCxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRTtRQUN2RCx5Q0FBeUM7UUFDekMsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsV0FBVyxFQUFFO0tBQzFEOzJGQUVVLGNBQWM7a0JBVDFCLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLGtCQUFrQjtvQkFDNUIsUUFBUSxFQUFFLGdCQUFnQjtv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QUM1Qzs7MEJBUUksTUFBTTsyQkFBQyw2QkFBNkI7OzBCQUVwQyxNQUFNOzJCQUFDLG9DQUFvQzttREFJakIsY0FBYzswQkFEeEMsUUFBUTs4QkFHZSxXQUFXOzBCQURsQyxRQUFROztBQTZCYixNQUFNLE9BQU8sb0JBQW9COztpSEFBcEIsb0JBQW9CO2tIQUFwQixvQkFBb0IsaUJBekdwQixjQUFjLEVBOERkLE9BQU8sRUEvQ1AsV0FBVyxhQWZYLGNBQWMsRUE4RGQsT0FBTyxFQS9DUCxXQUFXO2tIQTBGWCxvQkFBb0I7MkZBQXBCLG9CQUFvQjtrQkFKaEMsUUFBUTttQkFBQztvQkFDUixZQUFZLEVBQUUsQ0FBQyxjQUFjLEVBQUUsT0FBTyxFQUFFLFdBQVcsQ0FBQztvQkFDcEQsT0FBTyxFQUFFLENBQUMsY0FBYyxFQUFFLE9BQU8sRUFBRSxXQUFXLENBQUM7aUJBQ2hEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgTkdUX01BVEVSSUFMX0dFT01FVFJZX0NPTlRST0xMRVJfUFJPVklERVIsXG4gIE5HVF9PQkpFQ1RfQ09OVFJPTExFUl9QUk9WSURFUixcbiAgTkdUX09CSkVDVF9JTlBVVFNfV0FUQ0hFRF9DT05UUk9MTEVSLFxuICBOR1RfT0JKRUNUX1RZUEUsXG4gIE5HVF9PQkpFQ1RfV0FUQ0hFRF9DT05UUk9MTEVSLFxuICBOZ3RDb21tb25NZXNoLFxuICBOZ3RNYXRyaXg0LFxuICBOZ3RPYmplY3QzZENvbnRyb2xsZXIsXG4gIE5ndE9iamVjdDNkSW5wdXRzQ29udHJvbGxlcixcbn0gZnJvbSAnQGFuZ3VsYXItdGhyZWUvY29yZSc7XG5pbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5qZWN0LFxuICBJbnB1dCxcbiAgTmdNb2R1bGUsXG4gIE5nWm9uZSxcbiAgT25Jbml0LFxuICBPcHRpb25hbCxcbiAgT3V0cHV0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHJlcXVlc3RBbmltYXRpb25GcmFtZSB9IGZyb20gJ0ByeC1hbmd1bGFyL2Nkay96b25lLWxlc3MnO1xuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICduZ3Qtc2tpbm5lZC1tZXNoJyxcbiAgZXhwb3J0QXM6ICduZ3RTa2lubmVkTWVzaCcsXG4gIHByb3ZpZGVyczogW1xuICAgIHsgcHJvdmlkZTogTmd0Q29tbW9uTWVzaCwgdXNlRXhpc3Rpbmc6IE5ndFNraW5uZWRNZXNoIH0sXG4gICAgTkdUX01BVEVSSUFMX0dFT01FVFJZX0NPTlRST0xMRVJfUFJPVklERVIsXG4gICAgeyBwcm92aWRlOiBOR1RfT0JKRUNUX1RZUEUsIHVzZVZhbHVlOiBUSFJFRS5Ta2lubmVkTWVzaCB9LFxuICBdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RTa2lubmVkTWVzaCBleHRlbmRzIE5ndENvbW1vbk1lc2g8VEhSRUUuU2tpbm5lZE1lc2g+IHtcbiAgQElucHV0KCkgc2V0IGFyZ3ModjogW2Jvb2xlYW5dKSB7XG4gICAgaWYgKHRoaXMubWF0ZXJpYWxHZW9tZXRyeUNvbnRyb2xsZXIpIHtcbiAgICAgIHRoaXMubWF0ZXJpYWxHZW9tZXRyeUNvbnRyb2xsZXIubWVzaEFyZ3MgPSB2O1xuICAgIH1cbiAgfVxuXG4gIEBJbnB1dCgpIGJpbmRNYXRyaXg/OiBOZ3RNYXRyaXg0O1xuICBASW5wdXQoKSBiaW5kTW9kZT86IHN0cmluZztcbn1cblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnbmd0LXNrZWxldG9uJyxcbiAgZXhwb3J0QXM6ICduZ3RTa2VsZXRvbicsXG59KVxuZXhwb3J0IGNsYXNzIE5ndFNrZWxldG9uIGltcGxlbWVudHMgT25Jbml0IHtcbiAgQElucHV0KCkgYm9uZUludmVyc2VzPzogTmd0TWF0cml4NFtdO1xuICBAT3V0cHV0KCkgcmVhZHkgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgI3NrZWxldG9uPzogVEhSRUUuU2tlbGV0b247XG4gIGdldCBza2VsZXRvbigpIHtcbiAgICByZXR1cm4gdGhpcy4jc2tlbGV0b247XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG5nWm9uZTogTmdab25lLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgc2tpbm5lZE1lc2g6IE5ndFNraW5uZWRNZXNoXG4gICkge1xuICAgIGlmICghc2tpbm5lZE1lc2gpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbmd0LXNrZWxldG9uIG11c3QgYmUgdXNlZCB3aXRoaW4gYSBuZ3Qtc2tpbm5lZC1tZXNoJyk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgY29uc3QgYm9uZUludmVyc2VzOiBUSFJFRS5NYXRyaXg0W10gfCB1bmRlZmluZWQgPSB0aGlzLmJvbmVJbnZlcnNlc1xuICAgICAgICA/IHRoaXMuYm9uZUludmVyc2VzLm1hcCgodGhyZWVNYXh0cml4KSA9PiB7XG4gICAgICAgICAgICBpZiAodGhyZWVNYXh0cml4IGluc3RhbmNlb2YgVEhSRUUuTWF0cml4NCkgcmV0dXJuIHRocmVlTWF4dHJpeDtcbiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWF0cml4NCgpLnNldCguLi50aHJlZU1heHRyaXgpO1xuICAgICAgICAgIH0pXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgdGhpcy4jc2tlbGV0b24gPSBuZXcgVEhSRUUuU2tlbGV0b24oW10sIGJvbmVJbnZlcnNlcyk7XG4gICAgICB0aGlzLnJlYWR5LmVtaXQoKTtcblxuICAgICAgaWYgKHRoaXMuc2tpbm5lZE1lc2gpIHtcbiAgICAgICAgY29uc3QgYmluZE1hdHJpeDogVEhSRUUuTWF0cml4NCB8IHVuZGVmaW5lZCA9IHRoaXMuc2tpbm5lZE1lc2hcbiAgICAgICAgICAuYmluZE1hdHJpeFxuICAgICAgICAgID8gdGhpcy5za2lubmVkTWVzaC5iaW5kTWF0cml4IGluc3RhbmNlb2YgVEhSRUUuTWF0cml4NFxuICAgICAgICAgICAgPyB0aGlzLnNraW5uZWRNZXNoLmJpbmRNYXRyaXhcbiAgICAgICAgICAgIDogbmV3IFRIUkVFLk1hdHJpeDQoKS5zZXQoLi4udGhpcy5za2lubmVkTWVzaC5iaW5kTWF0cml4KVxuICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnNraW5uZWRNZXNoLm1lc2guYmluZCh0aGlzLnNrZWxldG9uISwgYmluZE1hdHJpeCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnbmd0LWJvbmUnLFxuICBleHBvcnRBczogJ25ndEJvbmUnLFxuICBwcm92aWRlcnM6IFtOR1RfT0JKRUNUX0NPTlRST0xMRVJfUFJPVklERVJdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RCb25lIGltcGxlbWVudHMgT25Jbml0IHtcbiAgI2JvbmU/OiBUSFJFRS5Cb25lO1xuICBnZXQgYm9uZSgpIHtcbiAgICByZXR1cm4gdGhpcy4jYm9uZTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoTkdUX09CSkVDVF9XQVRDSEVEX0NPTlRST0xMRVIpXG4gICAgcHJpdmF0ZSBvYmplY3RDb250cm9sbGVyOiBOZ3RPYmplY3QzZENvbnRyb2xsZXIsXG4gICAgQEluamVjdChOR1RfT0JKRUNUX0lOUFVUU19XQVRDSEVEX0NPTlRST0xMRVIpXG4gICAgcHJpdmF0ZSBvYmplY3RJbnB1dHNDb250cm9sbGVyOiBOZ3RPYmplY3QzZElucHV0c0NvbnRyb2xsZXIsXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICBAT3B0aW9uYWwoKVxuICAgIHByaXZhdGUgcGFyZW50U2tpbm5lZE1lc2g6IE5ndFNraW5uZWRNZXNoLFxuICAgIEBPcHRpb25hbCgpXG4gICAgcHJpdmF0ZSBwYXJlbnRTa2VsZXRvbjogTmd0U2tlbGV0b25cbiAgKSB7XG4gICAgaWYgKCFwYXJlbnRTa2lubmVkTWVzaCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCduZ3QtYm9uZSBtdXN0IGJlIHVzZWQgd2l0aGluIGEgbmd0LXNraW5uZWQtbWVzaCcpO1xuICAgIH1cbiAgICBvYmplY3RJbnB1dHNDb250cm9sbGVyLmFwcGVuZFRvID0gcGFyZW50U2tpbm5lZE1lc2gubWVzaDtcbiAgICBvYmplY3RDb250cm9sbGVyLmluaXRGbiA9ICgpID0+IHtcbiAgICAgIHRoaXMuI2JvbmUgPSBuZXcgVEhSRUUuQm9uZSgpO1xuICAgICAgcmV0dXJuIHRoaXMuI2JvbmU7XG4gICAgfTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMub2JqZWN0Q29udHJvbGxlci5pbml0KCk7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5wYXJlbnRTa2VsZXRvbiAmJiB0aGlzLnBhcmVudFNrZWxldG9uLnNrZWxldG9uKSB7XG4gICAgICAgICAgdGhpcy5wYXJlbnRTa2VsZXRvbi5za2VsZXRvbi5ib25lcy5wdXNoKHRoaXMuYm9uZSEpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5ATmdNb2R1bGUoe1xuICBkZWNsYXJhdGlvbnM6IFtOZ3RTa2lubmVkTWVzaCwgTmd0Qm9uZSwgTmd0U2tlbGV0b25dLFxuICBleHBvcnRzOiBbTmd0U2tpbm5lZE1lc2gsIE5ndEJvbmUsIE5ndFNrZWxldG9uXSxcbn0pXG5leHBvcnQgY2xhc3MgTmd0U2tpbm5lZE1lc2hNb2R1bGUge31cbiJdfQ==